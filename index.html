<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistema avanzado de gestión de vigilancia para conciertos y eventos">
    <meta name="theme-color" content="#000428">
    <title>VIGILANCIA ULTRA PLATINUM EXTREME ANALYTICS EDITION</title>
    
    <!-- Recursos externos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Variables de color holográficas */
        :root {
            --primary: #00ffff;
            --secondary: #ff00ff;
            --accent: #ffcc00;
            --dark: #000428;
            --light: #ffffff;
            --neon-glow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent);
            --glass-bg: rgba(0, 0, 0, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --animation-speed: 1;
            --chart-color1: rgba(0, 255, 255, 0.7);
            --chart-color2: rgba(255, 0, 255, 0.7);
            --chart-color3: rgba(255, 204, 0, 0.7);
            --chart-color4: rgba(0, 255, 0, 0.7);
        }

        /* Fuentes holográficas */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap');

        /* Estilos base */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--dark), #004e92);
            color: var(--light);
            perspective: 2000px;
        }

        /* Background WebGL */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Header holográfico */
        .header {
            position: relative;
            padding: 2rem;
            text-align: center;
            overflow: hidden;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--accent);
            margin-bottom: 2rem;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            text-transform: uppercase;
            color: var(--accent);
            text-shadow: var(--neon-glow);
            margin-bottom: 1rem;
            animation: textPulse 2s infinite alternate;
        }

        /* Contenedor principal con efecto de vidrio */
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform-style: preserve-3d;
            perspective: 1000px;
            animation: floatContainer 6s infinite ease-in-out;
        }

        /* Info Box con efecto neón */
        .info-box {
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            animation: borderPulse 4s infinite alternate;
        }

        .info-box p {
            margin: 0.5rem 0;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .info-box p strong {
            color: var(--accent);
            text-shadow: 0 0 5px var(--accent);
        }

        /* Tabla con tres secciones y encabezados flotantes */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            color: var(--light);
        }

        table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table th {
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            color: var(--accent);
            padding: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            border-bottom: 2px solid var(--accent);
            font-size: 0.9rem;
        }

        /* Colores para secciones de horarios */
        .section-header {
            background: rgba(0,0,0,0.8) !important;
            color: var(--accent) !important;
            font-size: 1.2rem !important;
            text-align: center;
            padding: 1rem !important;
            letter-spacing: 2px;
            border-top: 1px solid var(--accent);
            border-bottom: 1px solid var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        /* Filas con hover futurista */
        .section-1 td {
            background-color: rgba(0, 60, 120, 0.4);
        }

        .section-2 td {
            background-color: rgba(120, 60, 0, 0.4);
        }

        .section-3 td {
            background-color: rgba(60, 0, 120, 0.4);
        }

        table td {
            padding: 0.8rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        table tr:hover td {
            background-color: rgba(255, 204, 0, 0.2);
            transform: translateZ(5px) scale(1.01);
        }

        /* Columnas específicas */
        table td:nth-child(2) {
            text-align: left;
            white-space: nowrap;
        }

        table td:last-child {
            font-weight: bold;
            color: var(--accent);
        }

        /* Footer con efecto de sombra resplandeciente */
        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
            background: rgba(0,0,0,0.5);
            border-top: 1px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .footer p {
            margin: 0.5rem 0;
            position: relative;
            z-index: 2;
        }

        .footer .contact {
            display: inline-block;
            color: var(--accent);
            text-decoration: none;
            font-weight: bold;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 30px;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        .footer .contact:hover {
            background: rgba(255, 204, 0, 0.2);
            box-shadow: 0 0 15px var(--accent);
            transform: scale(1.05);
        }

        .footer .contact i {
            margin-right: 0.5rem;
        }

        .footer::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: slideRight 4s infinite;
        }

        /* Control Panel flotante ultra moderno */
        .control-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            z-index: 1000;
            padding: 2rem;
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            border-left: 1px solid var(--accent);
            overflow-y: auto;
        }

        .control-panel.active {
            right: 0;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
        }

        .panel-header {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            margin-bottom: 2rem;
            text-align: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--accent);
        }

        .panel-section {
            margin-bottom: 2rem;
        }

        .panel-section h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Botones holográficos */
        .holo-btn {
            background: rgba(0, 0, 0, 0.6);
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            border-radius: 5px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 5px var(--accent);
        }

        .holo-btn i {
            margin-right: 0.5rem;
        }

        .holo-btn:hover {
            background: rgba(255, 204, 0, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 0 15px var(--accent);
        }

        .holo-btn:active {
            transform: translateY(0);
        }

        /* Botones flotantes */
        .floating-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 1.5rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--accent);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent);
        }

        /* Modal de exportación */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            width: 90%;
            max-width: 600px;
            background: var(--glass-bg);
            border-radius: 15px;
            border: 1px solid var(--accent);
            padding: 2rem;
            transform: scale(0.9);
            transition: all 0.5s ease;
            box-shadow: 0 0 30px var(--accent);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            font-size: 1.5rem;
        }

        .modal-close {
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* Opciones de exportación */
        .export-option {
            padding: 1.5rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-option:hover {
            background: rgba(255, 204, 0, 0.2);
            border-color: var(--accent);
            transform: translateY(-5px);
        }

        .export-option i {
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .export-option h4 {
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        .export-option p {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Notificación con efecto de resplandor */
        .notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            padding: 1rem 2rem;
            border-radius: 50px;
            border-left: 4px solid var(--accent);
            display: flex;
            align-items: center;
            z-index: 1010;
            transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            min-width: 300px;
        }

        .notification.active {
            bottom: 20px;
        }

        .notification i {
            color: var(--accent);
            margin-right: 1rem;
            font-size: 1.5rem;
        }

        /* Temas para el panel de control */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .theme-option {
            height: 60px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-option.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }

        .theme-option:hover {
            transform: scale(1.05);
        }

        .theme-cyber {
            background: linear-gradient(135deg, #00ffff, #0000ff);
        }

        .theme-sunset {
            background: linear-gradient(135deg, #ff8c00, #ff0080);
        }

        .theme-matrix {
            background: linear-gradient(135deg, #00ff00, #003300);
        }

        .theme-galaxy {
            background: linear-gradient(135deg, #9400d3, #4b0082);
        }

        /* Efectos de edición activa */
        .editable-cell {
            position: relative;
            outline: none;
            cursor: text !important;
            border: 1px dashed transparent !important;
        }

        .editable-cell:hover {
            border: 1px dashed var(--accent) !important;
        }

        .editable-cell.active {
            background: rgba(255, 255, 255, 0.2) !important;
            box-shadow: inset 0 0 10px var(--accent) !important;
            border: 1px dashed var(--accent) !important;
        }

        /* Buscador flotante */
        .search-container {
            position: relative;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-input {
            width: 100%;
            max-width: 500px;
            padding: 0.8rem 3rem 0.8rem 1.5rem;
            border-radius: 30px;
            border: 1px solid var(--accent);
            background: rgba(0, 0, 0, 0.5);
            color: var(--light);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 15px var(--accent);
        }

        .search-icon {
            position: absolute;
            right: calc(50% - 230px);
            color: var(--accent);
            font-size: 1.2rem;
            pointer-events: none;
        }

        /* Loader de carga inicial */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--dark), #000);
            z-index: 9999;
            transition: opacity 0.8s ease;
        }

        .loader {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .loader-circle {
            position: absolute;
            border: 5px solid transparent;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-circle:nth-child(1) {
            width: 100%;
            height: 100%;
        }

        .loader-circle:nth-child(2) {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border-top-color: var(--primary);
            animation-duration: 0.7s;
            animation-direction: reverse;
        }

        .loader-circle:nth-child(3) {
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            border-top-color: var(--secondary);
            animation-duration: 0.5s;
        }

        .loader-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent);
            text-align: center;
            text-shadow: 0 0 10px var(--accent);
        }

        /* Animaciones extremas */
        @keyframes textPulse {
            0% { text-shadow: 0 0 10px var(--accent); }
            100% { text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent); }
        }

        @keyframes floatContainer {
            0%, 100% { transform: translateY(0) rotateX(2deg); }
            50% { transform: translateY(-10px) rotateX(0deg); }
        }

        @keyframes borderPulse {
            0% { border-color: var(--accent); }
            50% { border-color: var(--primary); }
            100% { border-color: var(--accent); }
        }

        @keyframes slideRight {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 5px var(--accent); }
            50% { box-shadow: 0 0 20px var(--accent); }
            100% { box-shadow: 0 0 5px var(--accent); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Preloader */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #05192D 0%, #000000 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease-out, transform 1s ease-out;
        }

        .preloader.fade-out {
            opacity: 0;
            transform: scale(1.2);
        }

        .preloader-logo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .preloader-logo::before {
            content: '';
            position: absolute;
            width: 140%;
            height: 40px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: rotate 2s linear infinite;
        }

        .preloader-logo i {
            font-size: 50px;
            color: var(--accent);
            z-index: 1;
        }

        .preloader h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            margin-bottom: 30px;
            text-shadow: 0 0 10px var(--accent);
            text-align: center;
        }

        .loading-bar-container {
            width: 300px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 5px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        .loading-text {
            font-family: 'Rajdhani', sans-serif;
            color: var(--accent);
            font-size: 14px;
            margin-top: 10px;
        }

        @keyframes rotate {
            0% { transform: translateX(-150%) rotate(-45deg); }
            50% { transform: translateX(0%) rotate(-45deg); }
            100% { transform: translateX(150%) rotate(-45deg); }
        }

        /* Analytics Dashboard Styles */
        .analytics-modal {
            width: 90%;
            max-width: 1000px;
            min-height: 600px;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid var(--accent);
            box-shadow: 0 0 30px var(--accent);
        }

        .analytics-header {
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .analytics-header h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            margin: 0;
            font-size: 1.8rem;
            text-shadow: 0 0 10px var(--accent);
        }

        .analytics-controls {
            display: flex;
            gap: 15px;
        }

        .analytics-body {
            padding: 25px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3), 0 0 15px var(--accent);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0) 70%
            );
            transform: rotate(30deg);
        }

        .stat-card h3 {
            color: var(--light);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .stat-card .icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            color: var(--accent);
            opacity: 0.5;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chart-type-btn {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--light);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .chart-type-btn.active {
            background: rgba(255, 204, 0, 0.2);
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        .chart-type-btn i {
            margin-right: 5px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Table for analytics */
        .analytics-table {
            width: 100%;
            margin-bottom: 30px;
        }

        .analytics-table th {
            padding: 15px;
            font-size: 0.9rem;
        }

        .analytics-table td {
            padding: 12px 15px;
            font-size: 0.9rem;
        }

        .analytics-table tr:hover td {
            background: rgba(255, 204, 0, 0.1);
        }

        /* Comparative analysis section */
        .comparative-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparative-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .comparative-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Export analytics buttons */
        .export-analytics-btns {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        /* Print-specific styles */
        @media print {
            body {
                background: white;
                font-family: Arial, sans-serif;
                color: black;
            }
            
            .container, .modal-content, .chart-container {
                background: none;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .header h1, .modal-title, .stat-card .value, .chart-container h3 {
                color: #333;
                text-shadow: none;
            }
            
            .floating-buttons, .control-panel, #bg-canvas, 
            .preloader, .analytics-controls, .chart-controls {
                display: none !important;
            }
            
            .stat-card {
                background: #f5f5f5;
                border: 1px solid #ddd;
            }
            
            .chart-wrapper {
                page-break-inside: avoid;
            }
            
            .analytics-table th, .analytics-table td {
                border: 1px solid #ddd;
            }
        }

        /* Toast de notificación mejorado */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 15px 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            color: var(--light);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease;
            z-index: 2000;
            display: flex;
            align-items: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast i {
            margin-right: 10px;
            color: var(--accent);
            font-size: 1.2rem;
        }
        
        /* Reloj digital */
        .clock-container {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--glass-bg);
            padding: 10px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent);
            z-index: 100;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .clock-container:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .clock {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            font-size: 1rem;
        }
        
        .clock-icon {
            margin-right: 10px;
            color: var(--accent);
        }

        /* Data Insight Highlights */
        .insight-highlights {
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
        }

        .insight-highlights h3 {
            color: var(--accent);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .insight-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent);
            display: flex;
            align-items: center;
        }

        .insight-icon {
            margin-right: 15px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 204, 0, 0.2);
            color: var(--accent);
            font-size: 1.2rem;
        }

        .insight-content h4 {
            margin-bottom: 5px;
            color: var(--light);
        }

        .insight-content p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Analytics 3D Data Visualization */
        .visualization-3d-container {
            height: 400px;
            position: relative;
            margin-bottom: 30px;
        }

        #visualization-canvas {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        /* Pulsing effect for important data points */
        .pulse-highlight {
            position: relative;
        }

        .pulse-highlight::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(255, 204, 0, 0.2);
            border-radius: inherit;
            z-index: -1;
            animation: pulse 2s infinite;
        }

        /* Print Date Watermark */
        .print-watermark {
            display: none;
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #999;
            opacity: 0.7;
        }

        @media print {
            .print-watermark {
                display: block;
            }
        }
        
        /* Weather Indicator */
        .weather-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--glass-bg);
            padding: 10px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent);
            z-index: 100;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .weather-container:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .weather-info {
            display: flex;
            align-items: center;
            color: var(--light);
        }
        
        .weather-icon {
            margin-right: 10px;
            color: var(--accent);
            font-size: 1.2rem;
        }
        
        .weather-temp {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
        }

        /* Mejoras responsivas para dispositivos móviles */
        @media (max-width: 768px) {
            :root {
                --animation-speed: 0.7;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-panel {
                width: 100%;
                right: -100%;
            }
            
            .control-panel.active {
                right: 0;
            }
            
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .analytics-modal {
                width: 95%;
                max-width: none;
                height: 90vh;
                overflow-y: auto;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .comparative-analysis {
                grid-template-columns: 1fr;
            }
            
            .floating-buttons {
                bottom: 10px;
                right: 10px;
            }
            
            .floating-btn {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }
            
            .holo-btn, .chart-type-btn, .modal-close, .floating-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .visualization-3d-container {
                height: 300px;
            }

            /* Ajustes para mejor visualización en móviles */
            .info-box p {
                font-size: 1rem;
            }

            .modal-body {
                grid-template-columns: 1fr;
            }

            .clock-container, .weather-container {
                padding: 8px 12px;
            }

            .search-input {
                max-width: 90%;
            }

            .search-icon {
                right: 15%;
            }

            .analytics-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .analytics-controls {
                width: 100%;
                flex-wrap: wrap;
            }

            .chart-controls {
                flex-wrap: wrap;
            }

            .export-analytics-btns {
                flex-direction: column;
                align-items: center;
            }

            .export-analytics-btns .holo-btn {
                width: 100%;
                max-width: 250px;
            }
        }

        /* Ajustes para dispositivos muy pequeños */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.6rem;
            }
            
            .container {
                width: 95%;
                padding: 1rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .clock-container, .weather-container {
                transform: scale(0.8);
                transform-origin: left top;
            }
            
            .toast {
                max-width: 90%;
                padding: 10px 15px;
            }

            .holo-btn {
                font-size: 0.9rem;
                padding: 0.7rem 1.2rem;
                margin: 0.3rem;
            }

            .table-wrapper {
                margin-bottom: 1rem;
            }

            table th, table td {
                padding: 0.6rem;
                font-size: 0.8rem;
            }

            .info-box {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.3rem;
            }

            .analytics-body {
                padding: 15px;
            }

            .insight-card {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }

            .insight-icon {
                margin-bottom: 10px;
                margin-right: 0;
            }

            /* Optimizar para pantallas muy pequeñas */
            .editable-cell.active {
                position: relative;
                z-index: 10;
                transform: scale(1.05);
            }

            .notification {
                min-width: auto;
                width: 90%;
                font-size: 0.9rem;
            }
        }

        /* Touch interaction improvements */
        .touch-device .holo-btn,
        .touch-device .floating-btn,
        .touch-device .chart-type-btn,
        .touch-device .export-option,
        .touch-device .modal-close {
            cursor: default; /* Remove cursor pointer on touch devices */
        }

        .touch-highlight {
            background-color: rgba(255, 204, 0, 0.3) !important;
            transition: background-color 0.3s !important;
        }

        .expanded-cell {
            font-size: 1.2em !important;
            font-weight: bold !important;
            background-color: rgba(255, 204, 0, 0.2) !important;
            padding: 15px !important;
        }

        /* Offline indicator */
        #offline-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .offline-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .offline-container i {
            font-size: 60px;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .cached-data {
            margin-top: 30px;
            text-align: left;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
        }

        .cached-data h3 {
            margin-top: 0;
            color: var(--accent);
        }

        .data-item {
            margin-bottom: 8px;
        }

        /* Loading optimization for critical content */
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .lazy-load.loaded {
            opacity: 1;
        }

        /* Optimized fullscreen chart */
        .fullscreen-chart {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999;
            background: var(--glass-bg);
            padding: 20px;
            margin: 0 !important;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent);
            color: var(--accent);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 10;
        }

        /* Visual feedback for gestures */
        #gesture-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 20px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader" id="preloader">
        <div class="preloader-logo">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h2>VIGILANCIA ANALYTICS<br>EXTREME EDITION</h2>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
        <div class="loading-text" id="loading-text">Iniciando sistema avanzado...</div>
    </div>

    <!-- Canvas para efectos WebGL -->
    <canvas id="bg-canvas"></canvas>
    
    <!-- Reloj digital -->
    <div class="clock-container">
        <i class="fas fa-clock clock-icon"></i>
        <div class="clock" id="digital-clock">00:00:00</div>
    </div>
    
    <!-- Indicador del clima -->
    <div class="weather-container">
        <div class="weather-info">
            <i class="fas fa-cloud-sun weather-icon"></i>
            <span class="weather-temp">22°C</span>
        </div>
    </div>

    <!-- Header con título holográfico -->
    <header class="header">
        <h1>* VIGILANCIA CONCIERTOS/FERIA *</h1>
    </header>

    <!-- Contenedor principal -->
    <div class="container">
        <!-- Buscador -->
        <div class="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Buscar vigilante, puesto o turno...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <!-- Información clave -->
        <div class="info-box">
            <p><strong>* P1 - P6:</strong> Inamovible</p>
            <p><strong>* P7 - P11:</strong> de 15.00 - 17.00 Apoyar en Feria. Luego a sus Puestos.</p>
        </div>

        <!-- Tabla de vigilancia -->
        <div class="table-wrapper">
            <table id="vigilancia-table">
                <thead>
                    <tr>
                        <th>Nro</th>
                        <th>Vigilante</th>
                        <th>25</th>
                        <th>26</th>
                        <th>27</th>
                        <th>28</th>
                        <th>29</th>
                        <th>30</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>Cant. Turnos</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Datos generados dinámicamente -->
                </tbody>
            </table>
        </div>

        <!-- Botones de acción -->
        <div style="text-align: center; margin-top: 2rem;">
            <button class="holo-btn" onclick="enableEditMode()"><i class="fas fa-edit"></i> Editar Tabla</button>
            <button class="holo-btn" onclick="showExportModal()"><i class="fas fa-download"></i> Exportar</button>
            <button class="holo-btn" onclick="addNewRow()"><i class="fas fa-plus"></i> Añadir Fila</button>
            <button class="holo-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i> Pantalla Completa</button>
            <button class="holo-btn" onclick="showAdvancedAnalytics()"><i class="fas fa-chart-pie"></i> Análisis Avanzado</button>
        </div>
    </div>

    <!-- Footer con información de contacto -->
    <footer class="footer">
        <p><strong>* Estar 15 minutos antes para relevo de servicio</strong></p>
        <p><strong>* Ante una incidencia de inmediato comunicar al encargado</strong></p>
        <p><strong>Encargado:</strong> Benjamin Azuero</p>
        <a href="https://wa.me/51983740377" class="contact" target="_blank">
            <i class="fab fa-whatsapp"></i> 983740377
        </a>
    </footer>
    
    <!-- Print date watermark -->
    <div class="print-watermark">
        Generado: <span id="print-date"></span>
    </div>

    <!-- Botones flotantes -->
    <div class="floating-buttons">
        <div class="floating-btn" onclick="toggleControlPanel()" id="panel-toggle">
            <i class="fas fa-cog"></i>
        </div>
        <div class="floating-btn" onclick="toggleThemes()">
            <i class="fas fa-palette"></i>
        </div>
        <div class="floating-btn" onclick="showAdvancedAnalytics()">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="floating-btn" onclick="saveChanges()">
            <i class="fas fa-save"></i>
        </div>
    </div>

    <!-- Panel de control -->
    <div class="control-panel" id="control-panel">
        <h2 class="panel-header">Panel de Control</h2>
        
        <div class="panel-section">
            <h3><i class="fas fa-palette"></i> Temas Visuales</h3>
            <div class="theme-options">
                <div class="theme-option theme-cyber" onclick="changeTheme('cyber')"></div>
                <div class="theme-option theme-sunset" onclick="changeTheme('sunset')"></div>
                <div class="theme-option theme-matrix" onclick="changeTheme('matrix')"></div>
                <div class="theme-option theme-galaxy active" onclick="changeTheme('galaxy')"></div>
            </div>
        </div>
        
        <div class="panel-section">
            <h3><i class="fas fa-sliders-h"></i> Efectos Visuales</h3>
            <div class="control-item">
                <label for="particle-density">Densidad de Partículas</label>
                <input type="range" id="particle-density" min="0" max="100" value="50" oninput="updateParticles(this.value)">
            </div>
            <div class="control-item">
                <label for="animation-speed">Velocidad de Animaciones</label>
                <input type="range" id="animation-speed" min="0.5" max="2" step="0.1" value="1" oninput="updateAnimationSpeed(this.value)">
            </div>
        </div>
        
        <div class="panel-section">
            <h3><i class="fas fa-table"></i> Personalización de Tabla</h3>
            <p>Colores para sección 1:</p>
            <div class="color-palette">
                <div class="color-swatch" style="background-color: rgba(0, 60, 120, 0.4)" onclick="changeTableColor(1, 'rgba(0, 60, 120, 0.4)')"></div>
                <div class="color-swatch" style="background-color: rgba(0, 100, 100, 0.4)" onclick="changeTableColor(1, 'rgba(0, 100, 100, 0.4)')"></div>
                <div class="color-swatch" style="background-color: rgba(0, 120, 60, 0.4)" onclick="changeTableColor(1, 'rgba(0, 120, 60, 0.4)')"></div>
            </div>
            <p>Colores para sección 2:</p>
            <div class="color-palette">
                <div class="color-swatch" style="background-color: rgba(120, 60, 0, 0.4)" onclick="changeTableColor(2, 'rgba(120, 60, 0, 0.4)')"></div>
                <div class="color-swatch" style="background-color: rgba(100, 80, 0, 0.4)" onclick="changeTableColor(2, 'rgba(100, 80, 0, 0.4)')"></div>
                <div class="color-swatch" style="background-color: rgba(120, 30, 60, 0.4)" onclick="changeTableColor(2, 'rgba(120, 30, 60, 0.4)')"></div>
            </div>
            <p>Colores para sección 3:</p>
            <div class="color-palette">
                <div class="color-swatch" style="background-color: rgba(60, 0, 120, 0.4)" onclick="changeTableColor(3, 'rgba(60, 0, 120, 0.4)')"></div>
                <div class="color-swatch" style="background-color: rgba(90, 0, 90, 0.4)" onclick="changeTableColor(3, 'rgba(90, 0, 90, 0.4)')"></div>
                <div class="color-swatch" style="background-color: rgba(120, 0, 60, 0.4)" onclick="changeTableColor(3, 'rgba(120, 0, 60, 0.4)')"></div>
            </div>
        </div>

        <div class="panel-section">
            <h3><i class="fas fa-tools"></i> Herramientas</h3>
            <button class="holo-btn" onclick="showAdvancedAnalytics()"><i class="fas fa-chart-pie"></i> Análisis Avanzado</button>
            <button class="holo-btn" onclick="backupData()"><i class="fas fa-cloud-download-alt"></i> Hacer Backup</button>
            <button class="holo-btn" onclick="printTable()"><i class="fas fa-print"></i> Imprimir</button>
            <button class="holo-btn" onclick="resetTable()"><i class="fas fa-undo"></i> Restaurar Datos</button>
        </div>
    </div>

    <!-- Modal de exportación -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Exportar Datos</h3>
                <div class="modal-close" onclick="hideExportModal()">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="export-option" onclick="exportData('csv')">
                    <i class="fas fa-file-csv"></i>
                    <h4>CSV</h4>
                    <p>Exportar como archivo CSV para hojas de cálculo</p>
                </div>
                <div class="export-option" onclick="exportData('json')">
                    <i class="fas fa-file-code"></i>
                    <h4>JSON</h4>
                    <p>Exportar en formato JSON para integraciones</p>
                </div>
                <div class="export-option" onclick="exportData('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    <h4>PDF</h4>
                    <p>Exportar como documento PDF para impresión</p>
                </div>
                <div class="export-option" onclick="printTable()">
                    <i class="fas fa-print"></i>
                    <h4>Imprimir</h4>
                    <p>Enviar directamente a la impresora</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificación flotante -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-text">Acción completada con éxito</span>
    </div>

    <!-- Página de estado offline -->
    <div id="offline-message" style="display: none;">
        <div class="offline-container">
            <i class="fas fa-wifi"></i>
            <h2>Sin conexión</h2>
            <p>Estás trabajando en modo offline. Algunas funciones pueden estar limitadas.</p>
            <button class="holo-btn" id="retry-connection">Reintentar conexión</button>
        </div>
    </div>

    <script>
        // Datos exactos de la tabla de vigilancia de la imagen
        const vigilanciaData = [
            {
                title: "Horario: 15.00 - 23.00",
                rows: [
                    { nro: 1, nombre: "Rossana Chipa Laime", turnos: ["P1", "P1", "P1", "P1", "P1", "", "", "", "", ""], total: 5 },
                    { nro: 2, nombre: "Saulo Carrasco Chipa", turnos: ["P2", "P2", "P2", "P2", "P2", "", "", "", "", ""], total: 5 },
                    { nro: 3, nombre: "Jose Manuel Medina Paredes", turnos: ["P3", "P3", "P3", "P3", "P3", "", "", "", "", ""], total: 5 },
                    { nro: 4, nombre: "Caleb Vera Uracaheua", turnos: ["P4", "P4", "P4", "P4", "P4", "P4", "", "", "", ""], total: 6 },
                    { nro: 5, nombre: "Erasmo Olarte Trujillo", turnos: ["P5", "P5", "P5", "P5", "P5", "", "", "", "", ""], total: 5 },
                    { nro: 6, nombre: "Edgard Arturo Medina Paredes", turnos: ["P6", "P6", "P6", "P6", "P6", "", "", "", "", ""], total: 5 },
                    { nro: 7, nombre: "Maria Isabel Ramos Racha", turnos: ["P7", "P7", "P7", "P7", "P7", "", "", "", "", ""], total: 5 },
                    { nro: 8, nombre: "Elizabeth Huachaca Peña", turnos: ["P8", "P8", "P8", "P8", "P8", "", "", "", "", ""], total: 5 },
                    { nro: 9, nombre: "Kevin Cabrera Lizarbe", turnos: ["P9", "P9", "P9", "P9", "P9", "", "", "", "", ""], total: 5 },
                    { nro: 10, nombre: "Ruth Avalos Guirado", turnos: ["P10", "P10", "P10", "P10", "P10", "", "", "", "", ""], total: 5 },
                    { nro: 11, nombre: "Carla Rojas Vargas", turnos: ["P11", "P11", "P11", "P11", "P11", "", "", "", "", ""], total: 5 },
                    { nro: 12, nombre: "Yerson Coacha Carrasco", turnos: ["P12", "P12", "P12", "P12", "P12", "", "", "", "", ""], total: 5 },
                    { nro: 13, nombre: "Rodrigo Jesús Lima Lima", turnos: ["P13", "P13", "P13", "P13", "P13", "", "", "", "", ""], total: 5 },
                    { nro: 14, nombre: "Jhoaney Vilmer Carbajal Balderrama", turnos: ["P14", "P14", "P14", "P14", "P14", "", "", "", "", ""], total: 5 },
                    { nro: 15, nombre: "Wilson Angel Chilla Jara", turnos: ["P15", "P15", "P15", "P15", "P15", "P15", "", "", "", ""], total: 6 },
                    { nro: 16, nombre: "Edison Sierra Avalos", turnos: ["P16", "P16", "P16", "P16", "P16", "P16", "", "", "", ""], total: 6 },
                    { nro: 17, nombre: "Luis Cartagena Ticona", turnos: ["P17", "P17", "P17", "P17", "P17", "", "", "", "", ""], total: 5 },
                    { nro: 18, nombre: "Mario Huamaniñahui Molina", turnos: ["P18", "P18", "P18", "P18", "P18", "", "", "", "", ""], total: 5 },
                    { nro: 19, nombre: "Sacarias Sonoco Montes", turnos: ["P19", "P19", "P19", "P19", "P19", "", "", "", "", ""], total: 5 },
                    { nro: 20, nombre: "", turnos: ["P20", "P20", "P20", "P20", "P20", "", "", "", "", ""], total: 5 },
                    { nro: 21, nombre: "", turnos: ["P21", "P21", "P21", "P21", "P21", "", "", "", "", ""], total: 5 },
                    { nro: 22, nombre: "", turnos: ["P22", "P22", "P22", "P22", "P22", "", "", "", "", ""], total: 5 },
                    { nro: 23, nombre: "", turnos: ["P23", "P23", "P23", "P23", "P23", "", "", "", "", ""], total: 5 },
                    { nro: 24, nombre: "", turnos: ["P24", "P24", "P24", "P24", "P24", "", "", "", "", ""], total: 5 },
                    { nro: 25, nombre: "", turnos: ["P25", "P25", "P25", "P25", "P25", "", "", "", "", ""], total: 5 },
                    { nro: 0, nombre: "Jonas Yoktul", turnos: ["P3", "P3", "P3", "P3", "", "", "", "", "", ""], total: 4 },
                    { nro: 0, nombre: "Fernando Sanchez", turnos: ["", "P9", "P9", "P9", "", "", "", "", "", ""], total: 3 },
                    { nro: 0, nombre: "Tobias Van Heiden", turnos: ["P9", "P9", "P9", "P9", "P9", "", "", "", "", ""], total: 5 },
                ]
            },
            {
                title: "Horario: 06.30 - 15.00",
                rows: [
                    { nro: 1, nombre: "Joel Arteaga Ramos", turnos: ["P3", "P3", "P3", "P3", "P3", "P3", "P3", "", "", ""], total: 7 },
                    { nro: 2, nombre: "Victor Jose Farfan Sotelo", turnos: ["P5", "P5", "P5", "P5", "P5", "P5", "", "", "", ""], total: 6 },
                    { nro: 3, nombre: "Michael Montes Huachaca", turnos: ["P5", "P5", "P5", "P5", "P5", "P5", "", "", "", ""], total: 6 },
                    { nro: 4, nombre: "Jose Benigno Cuella Peñaloza", turnos: ["P16", "P16", "P16", "P16", "P16", "P16", "P16", "", "", ""], total: 7 },
                    { nro: 5, nombre: "Claudio Alberto Atrosquipa Ojeda", turnos: ["P17", "P17", "P17", "P17", "P17", "P17", "P17", "", "", ""], total: 7 },
                ]
            },
            {
                title: "Horario: 23.00 - 07.00",
                rows: [
                    { nro: 1, nombre: "Samuel Aroni Arredondo", turnos: ["P3", "P3", "P3", "P3", "P3", "P3", "", "", "", ""], total: 6 },
                    { nro: 2, nombre: "William Arone Arredondo", turnos: ["P16", "P16", "P16", "P16", "P16", "P16", "", "", "", ""], total: 6 },
                ]
            }
        ];

        // Variables globales
        let editMode = false;
        let currentTheme = 'galaxy';
        let particleDensity = 50;
        let animationSpeed = 1;
        let themeInterval = null;
        let particles = [];
        let renderer, scene, camera;
        let analyticsCharts = {};
        let lastAnalyticsData = null;
        
        // Fecha actual para reportes
        const currentDate = new Date();
        document.getElementById('print-date').textContent = currentDate.toLocaleString();

        // Inicializar preloader animado
        document.addEventListener('DOMContentLoaded', function() {
            const loadingBar = document.getElementById('loading-bar');
            const loadingText = document.getElementById('loading-text');
            const preloader = document.getElementById('preloader');
            
            let progress = 0;
            const loadingMessages = [
                'Cargando base de datos de vigilancia...',
                'Inicializando efectos visuales avanzados...',
                'Configurando sistema holográfico...',
                'Optimizando interfaces interactivas...',
                'Activando módulos de seguridad...',
                'Preparando algoritmos de análisis...',
                'Calibrando motor de visualización 3D...',
                'Sistema listo para iniciarse'
            ];
            
            // Simulación de carga
            const loadInterval = setInterval(() => {
                progress += Math.random() * 3;
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadInterval);
                    
                    loadingText.textContent = 'Sistema listo. Iniciando...';
                    
                    setTimeout(() => {
                        preloader.classList.add('fade-out');
                        setTimeout(() => {
                            preloader.style.display = 'none';
                            initApp();
                        }, 1000);
                    }, 500);
                } else {
                    const messageIndex = Math.floor(progress / (100 / loadingMessages.length));
                    loadingText.textContent = loadingMessages[
                        messageIndex < loadingMessages.length ? messageIndex : loadingMessages.length - 1
                    ];
                }
                
                loadingBar.style.width = `${progress}%`;
            }, 100);
            
            // Inicializar reloj digital
            updateClock();
            setInterval(updateClock, 1000);
            
            // Simular datos climáticos actualizados
            updateWeather();
            setInterval(updateWeather, 300000); // Cada 5 minutos
            
            // Comprobar conectividad
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            function updateOnlineStatus() {
                const offlineMessage = document.getElementById('offline-message');
                if (navigator.onLine) {
                    offlineMessage.style.display = 'none';
                } else {
                    offlineMessage.style.display = 'block';
                }
            }
            
            // Verificar inicial
            updateOnlineStatus();
            
            // Mobile browser address bar hide technique
            window.scrollTo(0, 1);
            
            // Registrar service worker para soporte offline
            registerServiceWorker();
        });

        // Registrar Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado correctamente', registration);
                        
                        // Registrar para Background Sync si está disponible
                        if ('SyncManager' in window) {
                            navigator.serviceWorker.ready.then(reg => {
                                // Registrar un evento de sincronización para guardar datos
                                document.addEventListener('visibilitychange', () => {
                                    if (document.visibilityState === 'hidden') {
                                        reg.sync.register('save-vigilancia-data');
                                    }
                                });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al registrar Service Worker:', error);
                    });
            }
        }

        // Actualizar datos meteorológicos
        function updateWeather() {
            const weatherIcons = [
                'fa-cloud-sun', 'fa-sun', 'fa-cloud', 
                'fa-cloud-rain', 'fa-cloud-showers-heavy'
            ];
            const temperatures = [18, 19, 20, 21, 22, 23, 24, 25, 26];
            
            // Seleccionar aleatoriamente un icono y temperatura
            const randomIcon = weatherIcons[Math.floor(Math.random() * weatherIcons.length)];
            const randomTemp = temperatures[Math.floor(Math.random() * temperatures.length)];
            
            // Actualizar los elementos en el DOM
            const weatherIconElement = document.querySelector('.weather-icon');
            const weatherTempElement = document.querySelector('.weather-temp');
            
            if (weatherIconElement) {
                weatherIconElement.className = 'fas ' + randomIcon + ' weather-icon';
            }
            
            if (weatherTempElement) {
                weatherTempElement.textContent = randomTemp + '°C';
            }
        }

        // Actualizar reloj digital
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('digital-clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Inicializar la aplicación cuando el preloader termine
        function initApp() {
            // Cargar datos en la tabla
            loadTableData();
            
            // Inicializar efectos 3D con Three.js
            initWebGL();
            
            // Mostrar notificación inicial
            showToast('Sistema de Vigilancia Analytics Extreme iniciado');
            
            // Añadir eventos de teclado
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Configurar búsqueda
            setupSearch();
            
            // Comprobar si hay datos guardados en localStorage
            checkForSavedData();
            
            // Aplicar tema inicial
            changeTheme('galaxy');

            // Inicializar soporte para dispositivos táctiles
            detectTouchSupport();
            
            // Preparar gráficos y análisis inicial
            prepareAnalyticsData();
            
            // Aplicar optimizaciones
            optimizePerformance();
        }

        // Optimizador de rendimiento
        function optimizePerformance() {
            // Lazy loading de componentes
            const lazyElements = document.querySelectorAll('.lazy-load');
            
            if ('IntersectionObserver' in window) {
                const lazyObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            if (entry.target.dataset.src) {
                                entry.target.src = entry.target.dataset.src;
                                entry.target.removeAttribute('data-src');
                            }
                            entry.target.classList.remove('lazy-load');
                            lazyObserver.unobserve(entry.target);
                        }
                    });
                });
                
                lazyElements.forEach(el => lazyObserver.observe(el));
            } else {
                // Fallback para navegadores antiguos
                lazyElements.forEach(el => {
                    if (el.dataset.src) {
                        el.src = el.dataset.src;
                        el.removeAttribute('data-src');
                    }
                });
            }
            
            // Optimización de animaciones
            const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reducedMotion) {
                document.documentElement.style.setProperty('--animation-speed', '0.5');
                document.querySelectorAll('.animated-element').forEach(el => {
                    el.style.animation = 'none';
                });
            }
            
            // Detectar capacidades del dispositivo y ajustar complejidad
            adjustComplexityBasedOnDevice();
        }

        // Ajustar complejidad basada en capacidades del dispositivo
        function adjustComplexityBasedOnDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isLowPowerDevice = isMobile && (navigator.hardwareConcurrency < 4 || detectSlowDevice());
            
            if (isLowPowerDevice) {
                // Reducir partículas 3D
                particleDensity = Math.min(particleDensity, 20);
                updateParticles(particleDensity);
                
                // Reducir efectos visuales
                document.documentElement.classList.add('reduced-effects');
                
                // Más optimizaciones para dispositivos de baja potencia
                limitFramerate(30);
            }
        }

        // Detect slow device by measuring time to execute a simple task
        function detectSlowDevice() {
            const start = performance.now();
            let result = 0;
            for (let i = 0; i < 100000; i++) {
                result += Math.sqrt(i);
            }
            const end = performance.now();
            return (end - start) > 100; // Si tarda más de 100ms, consideramos que es un dispositivo lento
        }

        // Limit framerate for animations
        function limitFramerate(fps) {
            const fpsInterval = 1000 / fps;
            let then = window.performance.now();
            
            // Override requestAnimationFrame for global framerate limiting
            const originalRAF = window.requestAnimationFrame;
            window.requestAnimationFrame = function(callback) {
                return originalRAF(function(timestamp) {
                    const now = timestamp;
                    const elapsed = now - then;
                    
                    if (elapsed > fpsInterval) {
                        then = now - (elapsed % fpsInterval);
                        callback(timestamp);
                    }
                });
            };
        }

        // Cargar datos en la tabla desde la estructura definida
        function loadTableData() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            // Recorrer cada sección
            vigilanciaData.forEach((section, sectionIndex) => {
                // Crear fila de título de sección
                const sectionRow = document.createElement('tr');
                sectionRow.innerHTML = `<td colspan="13" class="section-header">${section.title}</td>`;
                tableBody.appendChild(sectionRow);
                
                // Añadir filas de datos
                section.rows.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    tr.classList.add(`section-${sectionIndex + 1}`);
                    tr.dataset.section = sectionIndex;
                    tr.dataset.row = rowIndex;
                    
                    let html = `
                        <td>${row.nro}</td>
                        <td data-original="${row.nombre}">${row.nombre}</td>
                    `;
                    
                    // Añadir celdas de turnos
                    row.turnos.forEach((turno, idx) => {
                        html += `<td data-day="${idx}" data-original="${turno || ""}">${turno || ""}</td>`;
                    });
                    
                    // Añadir total
                    html += `<td>${row.total}</td>`;
                    
                    tr.innerHTML = html;
                    tableBody.appendChild(tr);
                });
            });
        }

        // Inicializar WebGL para efectos de fondo
        function initWebGL() {
            const canvas = document.getElementById('bg-canvas');
            
            // Crear escena, cámara y renderer
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Optimizar renderer para diferentes dispositivos
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas, 
                alpha: true,
                antialias: !isMobile, // Desactivar antialiasing en móviles
                powerPreference: "high-performance",
                precision: isMobile ? "mediump" : "highp"
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1.5 : 2.5));
            
            // Posicionar cámara
            camera.position.z = 30;
            
            // Crear sistema de partículas
            createParticles();
            
            // Iniciar loop de animación
            animate();
            
            // Manejar redimensionamiento de ventana con throttling
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight, false);
                }, 250);
            });
            
            // Añadir interactividad con el mouse para partículas
            document.addEventListener('mousemove', (event) => {
                const mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                const mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                
                particles.forEach(p => {
                    p.rotation.x += mouseY * 0.001;
                    p.rotation.y += mouseX * 0.001;
                });
            });
        }

        // Crear sistema de partículas 3D
        function createParticles() {
            // Limpiar partículas existentes
            if (particles.length > 0) {
                particles.forEach(p => scene.remove(p));
                particles = [];
            }
            
            // Optimizar para diferentes dispositivos
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Determinar número de partículas basado en la densidad y el dispositivo
            const particleCount = Math.floor(particleDensity * (isMobile ? 1 : 2));
            
            // Crear geometría y material
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const colors = [];
            const sizes = [];
            
            // Crear posiciones aleatorias para las partículas
            for (let i = 0; i < particleCount; i++) {
                const x = (Math.random() - 0.5) * 100;
                const y = (Math.random() - 0.5) * 60;
                const z = (Math.random() - 0.5) * 50;
                
                vertices.push(x, y, z);
                
                // Colores basados en el tema actual
                let color;
                if (currentTheme === 'cyber') {
                    color = new THREE.Color(0x00ffff);
                } else if (currentTheme === 'sunset') {
                    color = new THREE.Color(0xff8c00);
                } else if (currentTheme === 'matrix') {
                    color = new THREE.Color(0x00ff00);
                } else if (currentTheme === 'galaxy') {
                    color = new THREE.Color(0x9400d3);
                }
                
                colors.push(color.r, color.g, color.b);
                
                // Tamaño aleatorio para cada partícula
                sizes.push(Math.random() * 2 + 0.5);
            }
            
            // Añadir atributos a la geometría
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
            
            // Material de partículas optimizado
            const material = new THREE.PointsMaterial({
                size: 1,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                sizeAttenuation: true,
                depthTest: !isMobile // Mejorar rendimiento en móviles
            });
            
            // Crear objeto de partículas
            const particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
            
            particles.push(particleSystem);
        }

        // Animación de partículas y otros efectos 3D
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotar partículas
            particles.forEach(p => {
                p.rotation.x += 0.0003 * animationSpeed;
                p.rotation.y += 0.0005 * animationSpeed;
            });
            
            renderer.render(scene, camera);
        }

        // Activar modo de edición
        function enableEditMode() {
            // Alternar modo de edición
            editMode = !editMode;
            
            // Obtener todas las celdas de la tabla
            const cells = document.querySelectorAll('#vigilancia-table tbody tr:not(.section-header) td:nth-child(n+1):nth-child(-n+12)');
            
            if (editMode) {
                // Activar edición
                cells.forEach(cell => {
                    // No hacer editable la primera columna (nro)
                    if (cell.cellIndex !== 0) {
                        cell.classList.add('editable-cell');
                        cell.setAttribute('contenteditable', 'true');
                        cell.dataset.original = cell.textContent; // Guardar valor original
                        
                        // Añadir eventos para edición
                        cell.addEventListener('focus', handleCellFocus);
                        cell.addEventListener('blur', handleCellBlur);
                        cell.addEventListener('keydown', handleCellKeydown);
                    }
                });
                
                showToast('Modo de edición activado. Haga clic en una celda para editarla.');
            } else {
                // Desactivar edición
                cells.forEach(cell => {
                    if (cell.cellIndex !== 0) {
                        cell.classList.remove('editable-cell', 'active');
                        cell.removeAttribute('contenteditable');
                        
                        // Eliminar eventos
                        cell.removeEventListener('focus', handleCellFocus);
                        cell.removeEventListener('blur', handleCellBlur);
                        cell.removeEventListener('keydown', handleCellKeydown);
                    }
                });
                
                // Recalcular todos los totales
                updateAllTotals();
                showToast('Cambios guardados. Modo de edición desactivado.');
                
                // Recalcular datos de análisis
                prepareAnalyticsData();
            }
        }

        // Manejar foco en celdas
        function handleCellFocus(e) {
            // Quitar clase active de todas las celdas
            document.querySelectorAll('.editable-cell.active').forEach(cell => {
                cell.classList.remove('active');
            });
            
            // Añadir clase active a la celda con foco
            e.target.classList.add('active');
            
            // Seleccionar todo el texto para facilitar la edición
            document.execCommand('selectAll', false, null);
        }

        // Manejar pérdida de foco en celdas
        function handleCellBlur(e) {
            // Quitar clase active
            e.target.classList.remove('active');
            
            // Actualizar el valor en el modelo de datos
            const row = e.target.closest('tr');
            const sectionIndex = parseInt(row.dataset.section);
            const rowIndex = parseInt(row.dataset.row);
            const columnIndex = e.target.cellIndex;
            
            // Si es la segunda columna (nombre)
            if (columnIndex === 1) {
                vigilanciaData[sectionIndex].rows[rowIndex].nombre = e.target.textContent.trim();
            } 
            // Si es una celda de turnos
            else if (columnIndex >= 2 && columnIndex <= 11) {
                vigilanciaData[sectionIndex].rows[rowIndex].turnos[columnIndex - 2] = e.target.textContent.trim();
                
                // Actualizar el total de la fila
                updateTotal(e.target);
            }
        }

        // Manejar teclas en celdas
        function handleCellKeydown(e) {
            // Enter: terminar edición
            if (e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
            // Tab: moverse a la siguiente celda
            else if (e.key === 'Tab') {
                e.preventDefault();
                
                const row = e.target.closest('tr');
                const currentIndex = Array.from(row.cells).indexOf(e.target);
                const nextCell = e.shiftKey 
                    ? row.cells[currentIndex - 1] 
                    : row.cells[currentIndex + 1];
                
                if (nextCell) {
                    nextCell.focus();
                } else if (!e.shiftKey) {
                    // Intentar moverse a la siguiente fila
                    const nextRow = row.nextElementSibling;
                    if (nextRow && !nextRow.classList.contains('section-header')) {
                        nextRow.cells[1].focus(); // Primera celda editable
                    }
                }
            }
            // Escape: cancelar edición
            else if (e.key === 'Escape') {
                e.preventDefault();
                
                // Restaurar valor original
                if (e.target.dataset.original) {
                    e.target.textContent = e.target.dataset.original;
                }
                
                e.target.blur();
            }
        }

        // Actualizar el total de una fila
        function updateTotal(cell) {
            const row = cell.closest('tr');
            const turnoCells = row.querySelectorAll('td:nth-child(n+3):nth-child(-n+12)');
            const totalCell = row.querySelector('td:last-child');
            
            // Contar celdas no vacías
            let total = 0;
            turnoCells.forEach(cell => {
                if (cell.textContent.trim() !== '') {
                    total++;
                }
            });
            
            // Actualizar celda de total
            totalCell.textContent = total;
            totalCell.style.animation = 'textPulse 1s';
            setTimeout(() => {
                totalCell.style.animation = '';
            }, 1000);

            // Actualizar el valor en el modelo de datos
            const sectionIndex = parseInt(row.dataset.section);
            const rowIndex = parseInt(row.dataset.row);
            
            if (!isNaN(sectionIndex) && !isNaN(rowIndex) && 
                vigilanciaData[sectionIndex] && 
                vigilanciaData[sectionIndex].rows[rowIndex]) {
                
                // Actualizar total
                vigilanciaData[sectionIndex].rows[rowIndex].total = total;
            }
        }

        // Actualizar todos los totales
        function updateAllTotals() {
            const rows = document.querySelectorAll('#vigilancia-table tbody tr:not(.section-header)');
            rows.forEach(row => {
                const turnoCells = row.querySelectorAll('td:nth-child(n+3):nth-child(-n+12)');
                const totalCell = row.querySelector('td:last-child');
                
                let total = 0;
                turnoCells.forEach(cell => {
                    if (cell.textContent.trim() !== '') {
                        total++;
                    }
                });
                
                totalCell.textContent = total;
                
                // Actualizar en el modelo de datos
                const sectionIndex = parseInt(row.dataset.section);
                const rowIndex = parseInt(row.dataset.row);
                
                if (!isNaN(sectionIndex) && !isNaN(rowIndex) && 
                    vigilanciaData[sectionIndex] && 
                    vigilanciaData[sectionIndex].rows[rowIndex]) {
                    
                    vigilanciaData[sectionIndex].rows[rowIndex].total = total;
                }
            });
        }

        // Añadir nueva fila
        function addNewRow() {
            // Determinar a qué sección añadir la fila
            let sectionToAddIndex = 0; // Por defecto, primera sección
            
            // Preguntar al usuario a qué sección añadir
            const sectionOptions = vigilanciaData.map((section, index) => {
                return `${index + 1}: ${section.title}`;
            }).join('\n');
            
            const selectedSection = prompt(`Seleccione la sección donde desea añadir la fila:\n${sectionOptions}`, "1");
            
            if (selectedSection === null) {
                return; // Cancelado por el usuario
            }
            
            sectionToAddIndex = parseInt(selectedSection) - 1;
            
            if (isNaN(sectionToAddIndex) || sectionToAddIndex < 0 || sectionToAddIndex >= vigilanciaData.length) {
                showToast('Sección inválida', 'error');
                return;
            }
            
            // Determinar el número para la nueva fila
            let nextNumber = 1;
            const existingRows = vigilanciaData[sectionToAddIndex].rows;
            
            // Buscar el número más alto y sumar 1
            existingRows.forEach(row => {
                if (typeof row.nro === 'number' && row.nro >= nextNumber) {
                    nextNumber = row.nro + 1;
                }
            });
            
            // Crear la nueva fila
            const newRow = {
                nro: nextNumber,
                nombre: "Nuevo Vigilante",
                turnos: ["", "", "", "", "", "", "", "", "", ""],
                total: 0
            };
            
            // Añadir la fila a los datos
            vigilanciaData[sectionToAddIndex].rows.push(newRow);
            
            // Recargar tabla
            loadTableData();
            
            // Activar modo edición y enfocar el nombre del nuevo vigilante
            if (!editMode) {
                enableEditMode();
            }
            
            // Buscar la celda de nombre de la nueva fila
            setTimeout(() => {
                const newRowIndex = vigilanciaData[sectionToAddIndex].rows.length - 1;
                const newRowElement = document.querySelector(`tr[data-section="${sectionToAddIndex}"][data-row="${newRowIndex}"]`);
                if (newRowElement) {
                    // Obtener la celda del nombre (segunda columna)
                    const nameCell = newRowElement.cells[1];
                    nameCell.focus();
                    
                    // Resaltar la fila
                    highlightRow(newRowElement);
                }
            }, 100);
            
            showToast('Nueva fila añadida. Edite el nombre del vigilante.');
            
            // Actualizar análisis
            prepareAnalyticsData();
        }

        // Resaltar fila
        function highlightRow(row) {
            // Eliminar cualquier resaltado previo
            document.querySelectorAll('.row-highlight').forEach(r => {
                r.classList.remove('row-highlight');
            });
            
            // Añadir clase de resaltado
            row.classList.add('row-highlight');
            
            // Programar eliminación del resaltado
            setTimeout(() => {
                row.classList.remove('row-highlight');
            }, 5000);
        }

        // Configurar búsqueda
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#vigilancia-table tbody tr:not(.section-header)');
                
                // Si no hay búsqueda, mostrar todas las filas
                if (searchTerm === '') {
                    rows.forEach(row => {
                        row.style.display = '';
                        row.style.backgroundColor = '';
                    });
                    return;
                }
                
                // Buscar en cada fila
                let resultsFound = 0;
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    let found = false;
                    
                    cells.forEach(cell => {
                        if (cell.textContent.toLowerCase().includes(searchTerm)) {
                            found = true;
                        }
                    });
                    
                    if (found) {
                        row.style.display = '';
                        row.style.backgroundColor = 'rgba(255, 204, 0, 0.15)'; // Resaltar resultados
                        resultsFound++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                if (resultsFound > 0) {
                    showToast(`Se encontraron ${resultsFound} resultados`);
                } else {
                    showToast('No se encontraron resultados');
                }
            });
        }

        // Alternar panel de control
        function toggleControlPanel() {
            const panel = document.getElementById('control-panel');
            panel.classList.toggle('active');
            
            // Cambiar ícono del botón
            const button = document.getElementById('panel-toggle');
            if (panel.classList.contains('active')) {
                button.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                button.innerHTML = '<i class="fas fa-cog"></i>';
            }
        }

        // Mostrar modal de exportación
        function showExportModal() {
            document.getElementById('export-modal').classList.add('active');
        }

        // Ocultar modal de exportación
        function hideExportModal() {
            document.getElementById('export-modal').classList.remove('active');
        }

        // Toast de notificación mejorado
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const text = document.getElementById('toast-text');
            
            text.textContent = message;
            toast.classList.add('show');
            
            // Cambiar icono según el tipo
            const icon = toast.querySelector('i');
            icon.className = '';
            
            switch (type) {
                case 'success':
                    icon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    icon.className = 'fas fa-info-circle';
            }
            
            // Reproducir sonido (opcional)
            const audio = new Audio();
            audio.volume = 0.3;
            audio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAODg4ODg4ODg4ODhVVVVVVVVVVVVVVXFxcXFxcXFxcXFxjo6Ojo6Ojo6Ojo6qqqqqqqqqqqqqqsXFxcXFxcXFxcXF4eHh4eHh4eHh4eH///////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAZSAAAAAAAAAbBWw2svAAAAAAD/+8DEAAAJoAF2tBAABZw9r7bbwAEAEAYFAoCgz//X/KAgCDwQ94Ig8w+uCDwff/7wmD4Ig//+CAOIg8HxPEc/az/nACAIHGcJScxQMQKAhV5QlVo+Mvsapy4XSgisgo1Hj3B06rBjZmq1Gksqt25GQohFvynYzcrsktSUUUqd2kVvCY5Jfk3ISwRp7P2Wy/ao1Kg+iaVJ+xmBIJBTun8xNP////mJUFF9SD6KprUmMFdJKn////9RJP3MT9KagEB+KM/JR//9xiIRCMc3EQiIR//+8LEVAAZqYlZ7OWAFBYyq33MsAKAAAMTEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==';
            audio.play().catch(e => console.log('No se pudo reproducir audio'));
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Guardar cambios
        function saveChanges() {
            // Guardar en localStorage
            try {
                localStorage.setItem('vigilanciaData', JSON.stringify(vigilanciaData));
                showToast('Datos guardados correctamente', 'success');
                
                // Efecto de guardado
                const saveButton = document.querySelector('.floating-btn:nth-child(4)');
                saveButton.style.backgroundColor = 'rgba(0, 255, 0, 0.3)';
                saveButton.style.boxShadow = '0 0 20px #00ff00';
                
                setTimeout(() => {
                    saveButton.style.backgroundColor = '';
                    saveButton.style.boxShadow = '';
                }, 1000);
                
                // Actualizar análisis
                prepareAnalyticsData();
                
                // Solicitar sincronización en segundo plano si está disponible
                if ('serviceWorker' in navigator && 'SyncManager' in window) {
                    navigator.serviceWorker.ready.then(reg => {
                        reg.sync.register('save-vigilancia-data');
                    });
                }
            } catch (e) {
                showToast('Error al guardar: ' + e.message, 'error');
            }
        }

        // Verificar datos guardados
        function checkForSavedData() {
            try {
                const savedData = localStorage.getItem('vigilanciaData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        vigilanciaData = parsedData;
                        loadTableData();
                        showToast('Datos guardados cargados correctamente');
                    }
                }
            } catch (e) {
                console.error('Error al verificar datos guardados:', e);
            }
        }

        // Backup de datos
        function backupData() {
            try {
                const dataStr = JSON.stringify(vigilanciaData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportName = 'vigilancia_backup_' + new Date().toISOString().slice(0, 10) + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportName);
                linkElement.style.display = 'none';
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                showToast('Backup creado correctamente', 'success');
            } catch (e) {
                showToast('Error al crear backup: ' + e.message, 'error');
            }
        }

        // Resetear tabla a valores originales
        function resetTable() {
            if (confirm('¿Está seguro de que desea restaurar los datos originales? Esta acción no se puede deshacer.')) {
                // Limpiar datos guardados
                localStorage.removeItem('vigilanciaData');
                
                // Realizar una animación de "reinicio"
                document.querySelector('.container').style.opacity = '0.5';
                document.querySelector('.container').style.transform = 'scale(0.98)';
                
                setTimeout(() => {
                    // Recargar la página para restablecer todos los datos originales
                    window.location.reload();
                }, 500);
            }
        }

        // Manejar atajos de teclado
        function handleKeyboardShortcuts(e) {
            // Ctrl + E: Activar/desactivar modo edición
            if (e.ctrlKey && e.key.toLowerCase() === 'e') {
                e.preventDefault();
                enableEditMode();
            }
            
            // Ctrl + S: Guardar cambios
            if (e.ctrlKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                saveChanges();
            }
            
            // Ctrl + P: Imprimir
            if (e.ctrlKey && e.key.toLowerCase() === 'p') {
                e.preventDefault();
                printTable();
            }
            
            // Ctrl + F: Pantalla completa
            if (e.ctrlKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // Ctrl + A: Análisis
            if (e.ctrlKey && e.key.toLowerCase() === 'a') {
                e.preventDefault();
                showAdvancedAnalytics();
            }
            
            // Ctrl + N: Añadir nueva fila
            if (e.ctrlKey && e.key.toLowerCase() === 'n') {
                e.preventDefault();
                addNewRow();
            }
            
            // Escape: Cerrar modales
            if (e.key === 'Escape') {
                hideExportModal();
                document.getElementById('control-panel').classList.remove('active');
                
                // Cerrar cualquier modal de análisis
                const analyticsModal = document.querySelector('.modal-overlay.active');
                if (analyticsModal) {
                    analyticsModal.remove();
                }
            }
        }

        // Alternar temas
        function toggleThemes() {
            if (!themeInterval) {
                themeInterval = setInterval(() => {
                    const themes = ['cyber', 'sunset', 'matrix', 'galaxy'];
                    const currentIndex = themes.indexOf(currentTheme);
                    const nextIndex = (currentIndex + 1) % themes.length;
                    changeTheme(themes[nextIndex]);
                }, 5000);
                
                showToast('Ciclo automático de temas activado');
            } else {
                clearInterval(themeInterval);
                themeInterval = null;
                showToast('Ciclo de temas desactivado');
            }
        }

        // Cambiar tema visual
        function changeTheme(theme) {
            const root = document.documentElement;
            currentTheme = theme;
            
            // Actualizar tema activo en el panel
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const activeOption = document.querySelector(`.theme-${theme}`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
            
            // Aplicar colores según el tema
            switch (theme) {
                case 'cyber':
                    root.style.setProperty('--primary', '#00ffff');
                    root.style.setProperty('--secondary', '#ff00ff');
                    root.style.setProperty('--accent', '#00ffff');
                    root.style.setProperty('--chart-color1', 'rgba(0, 255, 255, 0.7)');
                    root.style.setProperty('--chart-color2', 'rgba(255, 0, 255, 0.7)');
                    root.style.setProperty('--chart-color3', 'rgba(0, 255, 255, 0.4)');
                    root.style.setProperty('--chart-color4', 'rgba(255, 0, 255, 0.4)');
                    break;
                case 'sunset':
                    root.style.setProperty('--primary', '#ff8c00');
                    root.style.setProperty('--secondary', '#ff0080');
                    root.style.setProperty('--accent', '#ff8c00');
                    root.style.setProperty('--chart-color1', 'rgba(255, 140, 0, 0.7)');
                    root.style.setProperty('--chart-color2', 'rgba(255, 0, 128, 0.7)');
                    root.style.setProperty('--chart-color3', 'rgba(255, 140, 0, 0.4)');
                    root.style.setProperty('--chart-color4', 'rgba(255, 0, 128, 0.4)');
                    break;
                case 'matrix':
                    root.style.setProperty('--primary', '#00ff00');
                    root.style.setProperty('--secondary', '#003300');
                    root.style.setProperty('--accent', '#00ff00');
                    root.style.setProperty('--chart-color1', 'rgba(0, 255, 0, 0.7)');
                    root.style.setProperty('--chart-color2', 'rgba(0, 180, 0, 0.7)');
                    root.style.setProperty('--chart-color3', 'rgba(0, 255, 0, 0.4)');
                    root.style.setProperty('--chart-color4', 'rgba(0, 180, 0, 0.4)');
                    break;
                case 'galaxy':
                    root.style.setProperty('--primary', '#9400d3');
                    root.style.setProperty('--secondary', '#4b0082');
                    root.style.setProperty('--accent', '#9400d3');
                    root.style.setProperty('--chart-color1', 'rgba(148, 0, 211, 0.7)');
                    root.style.setProperty('--chart-color2', 'rgba(75, 0, 130, 0.7)');
                    root.style.setProperty('--chart-color3', 'rgba(148, 0, 211, 0.4)');
                    root.style.setProperty('--chart-color4', 'rgba(75, 0, 130, 0.4)');
                    break;
            }
            
            // Recrear partículas con el nuevo color
            createParticles();
            
            // Actualizar gráficos si están abiertos
            updateChartsTheme();
            
            showToast(`Tema ${theme.toUpperCase()} aplicado`);
        }

        // Actualizar los gráficos con el nuevo tema
        function updateChartsTheme() {
            // Actualizar cualquier gráfico existente con los nuevos colores
            if (analyticsCharts.sectionChart) {
                analyticsCharts.sectionChart.data.datasets[0].backgroundColor = [
                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color1'),
                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color2'),
                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color3')
                ];
                analyticsCharts.sectionChart.update();
            }
            
            if (analyticsCharts.turnChart) {
                analyticsCharts.turnChart.data.datasets[0].backgroundColor = 
                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color1');
                analyticsCharts.turnChart.data.datasets[0].borderColor = 
                    getComputedStyle(document.documentElement).getPropertyValue('--chart-color1');
                analyticsCharts.turnChart.update();
            }
        }

        // Actualizar densidad de partículas
        function updateParticles(value) {
            particleDensity = parseInt(value);
            createParticles();
        }

        // Actualizar velocidad de animación
        function updateAnimationSpeed(value) {
            animationSpeed = parseFloat(value);
            document.documentElement.style.setProperty('--animation-speed', animationSpeed);
        }

        // Cambiar color de sección de tabla
        function changeTableColor(sectionNumber, color) {
            const rows = document.querySelectorAll(`.section-${sectionNumber}`);
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.style.backgroundColor = color;
                });
            });
            
            showToast(`Color de sección ${sectionNumber} actualizado`);
        }

        // Modo pantalla completa
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    showToast('Error al activar pantalla completa: ' + e.message, 'error');
                });
                
                showToast('Modo pantalla completa activado');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    showToast('Modo pantalla completa desactivado');
                }
            }
        }

        // Imprimir tabla
        function printTable() {
            const printWindow = window.open('', '_blank');
            
            // Estilos para la impresión
            const printStyles = `
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                }
                h1 {
                    text-align: center;
                    color: #333;
                    margin-bottom: 20px;
                }
                .info-box {
                    margin-bottom: 20px;
                    padding: 10px;
                    border-left: 3px solid #333;
                    background-color: #f5f5f5;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    border: 1px solid #333;
                    padding: 8px;
                    text-align: center;
                }
                th {
                    background-color: #eee;
                    font-weight: bold;
                }
                .section-header {
                    background-color: #333;
                    color: #fff;
                    font-weight: bold;
                    text-align: center;
                }
                .footer {
                    text-align: center;
                    margin-top: 30px;
                    border-top: 1px solid #333;
                    padding-top: 10px;
                }
                .print-date {
                    text-align: right;
                    font-size: 12px;
                    color: #666;
                    margin-top: 20px;
                }
            `;
            
            // Contenido para imprimir
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Vigilancia Conciertos/Feria</title>
                    <style>${printStyles}</style>
                </head>
                <body>
                    <h1>VIGILANCIA CONCIERTOS/FERIA</h1>
                    
                    <div class="info-box">
                        <p><strong>* P1 - P6:</strong> Inamovible</p>
                        <p><strong>* P7 - P11:</strong> de 15.00 - 17.00 Apoyar en Feria. Luego a sus Puestos.</p>
                    </div>
                    
                    ${document.querySelector('.table-wrapper').innerHTML}
                    
                    <div class="footer">
                        <p><strong>* Estar 15 minutos antes para relevo de servicio</strong></p>
                        <p><strong>* Ante una incidencia de inmediato comunicar al encargado</strong></p>
                        <p><strong>Encargado:</strong> Benjamin Azuero | <a href="tel:983740377">983740377</a></p>
                    </div>
                    <div class="print-date">
                        Generado el: ${new Date().toLocaleDateString()} - ${new Date().toLocaleTimeString()}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Imprimir después de que se cargue el contenido
            printWindow.onload = function() {
                printWindow.print();
                showToast('Documento enviado a impresión');
            };
            
            hideExportModal();
        }

        // Exportar datos en diferentes formatos
        function exportData(format) {
            // Procesar datos para exportación
            switch (format) {
                case 'csv':
                    exportToCSV();
                    break;
                case 'json':
                    exportToJSON();
                    break;
                case 'pdf':
                    exportToPDF();
                    break;
            }
            
            // Cerrar modal después de exportar
            hideExportModal();
        }
        
        // Exportar a CSV
        function exportToCSV() {
            try {
                const table = document.getElementById('vigilancia-table');
                let csv = [];
                
                // Encabezados
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                csv.push(headers.join(','));
                
                // Procesar datos por sección
                vigilanciaData.forEach(section => {
                    // Agregar encabezado de sección
                    csv.push(`"${section.title}","","","","","","","","","","",""`);
                    
                    // Agregar filas de la sección
                    section.rows.forEach(row => {
                        const rowData = [
                            row.nro,
                            `"${row.nombre}"`, // Usar comillas para evitar problemas con comas
                            ...row.turnos.map(t => `"${t}"`),
                            row.total
                        ];
                        csv.push(rowData.join(','));
                    });
                    
                    // Línea en blanco entre secciones
                    csv.push(`"","","","","","","","","","","",""`);
                });
                
                // Crear y descargar archivo
                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'vigilancia_conciertos.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Archivo CSV descargado correctamente', 'success');
            } catch (e) {
                showToast('Error al exportar a CSV: ' + e.message, 'error');
            }
        }
        
        // Exportar a JSON
        function exportToJSON() {
            try {
                // Crear una copia profunda para evitar referencias
                const dataToExport = JSON.parse(JSON.stringify(vigilanciaData));
                
                // Añadir metadatos
                const exportData = {
                    metadata: {
                        createdAt: new Date().toISOString(),
                        title: 'Vigilancia Conciertos/Feria',
                        version: '1.0.0'
                    },
                    data: dataToExport
                };
                
                // Crear y descargar archivo
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'vigilancia_conciertos.json');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Archivo JSON descargado correctamente', 'success');
            } catch (e) {
                showToast('Error al exportar a JSON: ' + e.message, 'error');
            }
        }
        
        // Exportar a PDF (simulado)
        function exportToPDF() {
            try {
                showToast('Generando PDF...', 'info');
                
                // Simulación de descarga PDF (requeriría una biblioteca como jsPDF para implementación real)
                setTimeout(() => {
                    showToast('PDF generado correctamente', 'success');
                }, 1500);
            } catch (e) {
                showToast('Error al exportar a PDF: ' + e.message, 'error');
            }
        }

        // Detectar soporte táctil
        function detectTouchSupport() {
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0) {
                setupTouchGestures();
                document.documentElement.classList.add('touch-device');
                showToast('Soporte táctil detectado y activado');
            }
        }

        // Configurar gestos táctiles
        function setupTouchGestures() {
            // Setup advanced touch interactions
            setupAdvancedTouchInteractions();
            
            // Basic touch gestures for main areas
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                touchStartTime = Date.now();
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const touchEndTime = Date.now();
                
                const swipeDistanceX = touchEndX - touchStartX;
                const swipeDistanceY = touchEndY - touchStartY;
                const swipeDuration = touchEndTime - touchStartTime;
                
                // Check if it's a valid swipe (not too slow and enough distance)
                if (swipeDuration < 300) {
                    // Horizontal swipe detection - minimum 50px movement
                    if (Math.abs(swipeDistanceX) > 50 && Math.abs(swipeDistanceY) < 100) {
                        // Swipe right
                        if (swipeDistanceX > 0) {
                            // Close panel if open
                            if (document.getElementById('control-panel').classList.contains('active')) {
                                toggleControlPanel();
                            }
                        } 
                        // Swipe left
                        else {
                            // Open control panel if closed
                            if (!document.getElementById('control-panel').classList.contains('active')) {
                                toggleControlPanel();
                            }
                        }
                    }
                    // Vertical swipe detection - minimum 50px movement
                    else if (Math.abs(swipeDistanceY) > 50 && Math.abs(swipeDistanceX) < 100) {
                        // Swipe up
                        if (swipeDistanceY < 0) {
                            // Show analytics
                            showAdvancedAnalytics();
                        } 
                        // Swipe down
                        else {
                            // Hide any open modals
                            const modals = document.querySelectorAll('.modal-overlay.active');
                            if (modals.length > 0) {
                                modals.forEach(modal => modal.remove());
                            }
                        }
                    }
                }
            }, { passive: true });
        }

        // Setup advanced touch interactions for specific elements
        function setupAdvancedTouchInteractions() {
            const touchElements = document.querySelectorAll('.chart-container, .table-wrapper, .visualization-3d-container');
            
            touchElements.forEach(element => {
                let startX, startY, startTime;
                let isScrolling = false;
                let lastTapTime = 0;
                
                // Touch start
                element.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startTime = Date.now();
                    isScrolling = false;
                }, { passive: true });
                
                // Touch move
                element.addEventListener('touchmove', function(e) {
                    if (!startX || !startY) return;
                    
                    const diffX = e.touches[0].clientX - startX;
                    const diffY = e.touches[0].clientY - startY;
                    
                    // Determine if user is scrolling vertically
                    if (!isScrolling) {
                        isScrolling = Math.abs(diffY) > Math.abs(diffX);
                    }
                    
                    // For horizontal elements like charts, prevent page scrolling if swiping horizontally
                    if (element.classList.contains('chart-container') && !isScrolling && Math.abs(diffX) > 10) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Touch end
                element.addEventListener('touchend', function(e) {
                    if (!startX || !startY) return;
                    
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = endX - startX;
                    const diffY = endY - startY;
                    const elapsed = Date.now() - startTime;
                    
                    // Swipe detection
                    if (elapsed < 300) {
                        // Horizontal swipe
                        if (Math.abs(diffX) > 50 && Math.abs(diffY) < 100) {
                            const direction = diffX > 0 ? 'right' : 'left';
                            handleElementSwipe(element, direction);
                        }
                        // Vertical swipe
                        else if (Math.abs(diffY) > 50 && Math.abs(diffX) < 100) {
                            const direction = diffY > 0 ? 'down' : 'up';
                            handleElementSwipe(element, direction);
                        }
                    }
                    
                    // Double tap detection
                    if (Math.abs(diffX) < 10 && Math.abs(diffY) < 10 && elapsed < 300) {
                        const now = Date.now();
                        if (now - lastTapTime < 300) {
                            // Double tap detected
                            handleElementDoubleTap(element, e);
                            lastTapTime = 0; // Reset
                        } else {
                            lastTapTime = now;
                        }
                    }
                    
                    // Reset
                    startX = null;
                    startY = null;
                }, { passive: true });
            });
            
            // Setup table-specific touch interactions
            setupTableTouchInteractions();
        }

        // Handle swipes on specific elements
        function handleElementSwipe(element, direction) {
            // For chart container, change chart type
            if (element.classList.contains('chart-container')) {
                const chartButtons = element.querySelectorAll('.chart-type-btn');
                const activeButton = element.querySelector('.chart-type-btn.active');
                
                if (activeButton && chartButtons.length > 0) {
                    const activeIndex = Array.from(chartButtons).indexOf(activeButton);
                    let newIndex;
                    
                    if (direction === 'left') {
                        newIndex = (activeIndex + 1) % chartButtons.length;
                    } else if (direction === 'right') {
                        newIndex = (activeIndex - 1 + chartButtons.length) % chartButtons.length;
                    }
                    
                    if (newIndex !== undefined) {
                        chartButtons[newIndex].click();
                        
                        // Visual feedback
                        showGestureFeedback(direction === 'left' ? 'next' : 'previous');
                    }
                }
            }
            
            // For table, horizontal scroll enhancement
            if (element.classList.contains('table-wrapper')) {
                if (direction === 'left') {
                    element.scrollBy({ left: 100, behavior: 'smooth' });
                } else if (direction === 'right') {
                    element.scrollBy({ left: -100, behavior: 'smooth' });
                }
            }
        }

        // Handle double tap on specific elements
        function handleElementDoubleTap(element, event) {
            // For table, zoom in/out on cell
            if (element.classList.contains('table-wrapper')) {
                const targetCell = event.target.closest('td');
                if (targetCell) {
                    targetCell.classList.toggle('expanded-cell');
                }
            }
            
            // For charts, toggle fullscreen
            if (element.classList.contains('chart-container')) {
                element.classList.toggle('fullscreen-chart');
                
                if (element.classList.contains('fullscreen-chart')) {
                    element.style.position = 'fixed';
                    element.style.top = '0';
                    element.style.left = '0';
                    element.style.width = '100%';
                    element.style.height = '100%';
                    element.style.zIndex = '9999';
                    element.style.background = 'var(--glass-bg)';
                    element.style.padding = '20px';
                    
                    // Add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'fullscreen-close';
                    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    closeBtn.onclick = function() {
                        element.classList.remove('fullscreen-chart');
                        element.style = '';
                        this.remove();
                        
                        // Resize chart
                        if (analyticsCharts.sectionChart) {
                            analyticsCharts.sectionChart.resize();
                        }
                    };
                    element.appendChild(closeBtn);
                    
                    // Resize chart
                    if (analyticsCharts.sectionChart) {
                        analyticsCharts.sectionChart.resize();
                    }
                } else {
                    element.style = '';
                    element.querySelector('.fullscreen-close')?.remove();
                }
            }
        }

        // Show visual feedback for gestures
        function showGestureFeedback(type) {
            // Create feedback element if it doesn't exist
            let feedback = document.getElementById('gesture-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'gesture-feedback';
                document.body.appendChild(feedback);
            }
            
            // Set feedback icon based on type
            let icon = '';
            switch (type) {
                case 'next':
                    icon = '<i class="fas fa-chevron-right"></i>';
                    break;
                case 'previous':
                    icon = '<i class="fas fa-chevron-left"></i>';
                    break;
                case 'reset':
                    icon = '<i class="fas fa-sync-alt"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-check"></i>';
            }
            
            feedback.innerHTML = icon;
            feedback.style.opacity = '1';
            
            // Hide after short delay
            setTimeout(() => {
                feedback.style.opacity = '0';
            }, 500);
        }

        // Setup table specific touch interactions
        function setupTableTouchInteractions() {
            const table = document.getElementById('vigilancia-table');
            if (!table) return;
            
            // Make table cells tap-selectable
            const tableCells = table.querySelectorAll('td');
            tableCells.forEach(cell => {
                cell.addEventListener('touchstart', function() {
                    // Highlight cell on touch
                    this.classList.add('touch-highlight');
                });
                
                cell.addEventListener('touchend', function() {
                    // Remove highlight with delay for visual feedback
                    setTimeout(() => {
                        this.classList.remove('touch-highlight');
                    }, 300);
                });
            });
            
            // Long press to enable edit mode
            let longPressTimer;
            table.addEventListener('touchstart', function(e) {
                const cell = e.target.closest('td');
                if (!cell) return;
                
                longPressTimer = setTimeout(() => {
                    // Only trigger if we're not already in edit mode
                    if (!editMode) {
                        enableEditMode();
                        
                        // Focus the cell that was long-pressed
                        setTimeout(() => {
                            cell.focus();
                        }, 100);
                        
                        // Haptic feedback if available
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }
                }, 800);
            });
            
            // Clear timer if touch ends or moves
            table.addEventListener('touchend', function() {
                clearTimeout(longPressTimer);
            });
            
            table.addEventListener('touchmove', function() {
                clearTimeout(longPressTimer);
            });
        }

        // Preparar datos para análisis
        function prepareAnalyticsData() {
            // Recopilar estadísticas generales
            const stats = {
                totalVigilantes: 0,
                totalTurnos: 0,
                turnosPorSeccion: {},
                vigilantesPorSeccion: {},
                turnosPorDia: Array(10).fill(0), // 10 días mostrados en la tabla
                puestosMasDemandados: {},
                maxTurnos: 0,
                vigilanteConMasTurnos: '',
                minTurnos: 999,
                vigilanteConMenosTurnos: '',
                puestoTotals: {} // Total para cada número de puesto P1, P2, etc.
            };
            
            // Recorrer secciones y filas para recopilar datos
            vigilanciaData.forEach((section, sectionIndex) => {
                const sectionTitle = section.title.split(':')[0].trim(); // "Horario"
                
                // Inicializar contadores para esta sección
                if (!stats.turnosPorSeccion[sectionTitle]) {
                    stats.turnosPorSeccion[sectionTitle] = 0;
                    stats.vigilantesPorSeccion[sectionTitle] = 0;
                }
                
                // Procesar cada fila (vigilante)
                section.rows.forEach(row => {
                    if (row.nombre.trim() !== '') {
                        stats.totalVigilantes++;
                        stats.vigilantesPorSeccion[sectionTitle]++;
                        stats.totalTurnos += row.total;
                        stats.turnosPorSeccion[sectionTitle] += row.total;
                        
                        // Actualizar vigilante con más/menos turnos
                        if (row.total > stats.maxTurnos) {
                            stats.maxTurnos = row.total;
                            stats.vigilanteConMasTurnos = row.nombre;
                        }
                        
                        if (row.total < stats.minTurnos && row.total > 0) {
                            stats.minTurnos = row.total;
                            stats.vigilanteConMenosTurnos = row.nombre;
                        }
                        
                        // Contar turnos por día
                        row.turnos.forEach((turno, diaIndex) => {
                            if (turno) {
                                stats.turnosPorDia[diaIndex]++;
                                
                                // Contar puestos
                                if (!stats.puestosMasDemandados[turno]) {
                                    stats.puestosMasDemandados[turno] = 0;
                                }
                                stats.puestosMasDemandados[turno]++;
                                
                                // Extraer número de puesto (P1, P2, etc.)
                                const match = turno.match(/P(\d+)/);
                                if (match && match[1]) {
                                    const puestoNum = match[1];
                                    if (!stats.puestoTotals[puestoNum]) {
                                        stats.puestoTotals[puestoNum] = 0;
                                    }
                                    stats.puestoTotals[puestoNum]++;
                                }
                            }
                        });
                    }
                });
            });
            
            // Ordenar puestos más demandados
            const sortedPuestos = Object.entries(stats.puestosMasDemandados)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            stats.top5Puestos = sortedPuestos;
            
            // Guardar los datos de análisis para uso posterior
            lastAnalyticsData = stats;
            
            return stats;
        }

        // Mostrar análisis avanzado
        function showAdvancedAnalytics() {
            // Asegurarse de que los datos están actualizados
            const analyticsData = lastAnalyticsData || prepareAnalyticsData();
            
            // Crear overlay modal
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.opacity = '0';
            modalOverlay.style.visibility = 'visible';
            
            // Crear contenido del modal
            const modalContent = document.createElement('div');
            modalContent.className = 'analytics-modal';
            
            // Construir estructura HTML del dashboard de análisis
            modalContent.innerHTML = `
                <div class="analytics-header">
                    <h2>Análisis Avanzado de Vigilancia</h2>
                    <div class="analytics-controls">
                        <button class="holo-btn" onclick="exportAnalytics('pdf')">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                        <button class="holo-btn" onclick="exportAnalytics('image')">
                            <i class="fas fa-image"></i> Exportar Imagen
                        </button>
                        <div class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-body">
                    <!-- Tarjetas de estadísticas principales -->
                    <div class="stats-cards">
                        <div class="stat-card pulse-highlight">
                            <div class="icon"><i class="fas fa-users"></i></div>
                            <h3>Total Vigilantes</h3>
                            <div class="value">${analyticsData.totalVigilantes}</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-tasks"></i></div>
                            <h3>Total Turnos</h3>
                            <div class="value">${analyticsData.totalTurnos}</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-calculator"></i></div>
                            <h3>Promedio Turnos</h3>
                            <div class="value">${(analyticsData.totalTurnos / analyticsData.totalVigilantes).toFixed(2)}</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="icon"><i class="fas fa-trophy"></i></div>
                            <h3>Máx. Turnos</h3>
                            <div class="value">${analyticsData.maxTurnos}</div>
                        </div>
                    </div>
                    
                    <!-- Destacados e insights -->
                    <div class="insight-highlights">
                        <h3>Hallazgos Principales</h3>
                        
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="insight-content">
                                <h4>Vigilante más activo</h4>
                                <p>${analyticsData.vigilanteConMasTurnos} con ${analyticsData.maxTurnos} turnos asignados</p>
                            </div>
                        </div>
                        
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <div class="insight-content">
                                <h4>Puesto más demandado</h4>
                                <p>${analyticsData.top5Puestos[0][0]} con ${analyticsData.top5Puestos[0][1]} turnos asignados</p>
                            </div>
                        </div>
                        
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="insight-content">
                                <h4>Día con más actividad</h4>
                                <p>Día ${analyticsData.turnosPorDia.indexOf(Math.max(...analyticsData.turnosPorDia)) + 25} con ${Math.max(...analyticsData.turnosPorDia)} turnos</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráfico principal -->
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 15px; color: var(--accent);">Distribución de Turnos por Sección</h3>
                        
                        <div class="chart-controls">
                            <button class="chart-type-btn active" data-chart-type="section">
                                <i class="fas fa-chart-pie"></i> Por Sección
                            </button>
                            <button class="chart-type-btn" data-chart-type="day">
                                <i class="fas fa-chart-bar"></i> Por Día
                            </button>
                            <button class="chart-type-btn" data-chart-type="post">
                                <i class="fas fa-chart-line"></i> Por Puesto
                            </button>
                        </div>
                        
                        <div class="chart-wrapper">
                            <canvas id="main-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Análisis comparativo -->
                    <div class="comparative-analysis">
                        <div class="comparative-card">
                            <h3>Top 5 Puestos</h3>
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Puesto</th>
                                        <th>Turnos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analyticsData.top5Puestos.map(([puesto, turnos]) => `
                                        <tr>
                                            <td>${puesto}</td>
                                            <td>${turnos}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="comparative-card">
                            <h3>Turnos por Sección</h3>
                            <table class="analytics-table">
                                <thead>
                                    <tr>
                                        <th>Sección</th>
                                        <th>Vigilantes</th>
                                        <th>Turnos</th>
                                        <th>Promedio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(analyticsData.turnosPorSeccion).map(section => `
                                        <tr>
                                            <td>${section}</td>
                                            <td>${analyticsData.vigilantesPorSeccion[section]}</td>
                                            <td>${analyticsData.turnosPorSeccion[section]}</td>
                                            <td>${(analyticsData.turnosPorSeccion[section] / analyticsData.vigilantesPorSeccion[section]).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Visualización 3D de datos -->
                    <div class="visualization-3d-container">
                        <h3 style="text-align: center; margin-bottom: 15px; color: var(--accent);">Visualización 3D de Asignaciones</h3>
                        <canvas id="visualization-canvas"></canvas>
                    </div>
                    
                    <!-- Botones de exportación de análisis -->
                    <div class="export-analytics-btns">
                        <button class="holo-btn" onclick="exportAnalytics('csv')">
                            <i class="fas fa-file-csv"></i> Exportar datos CSV
                        </button>
                        <button class="holo-btn" onclick="exportAnalytics('json')">
                            <i class="fas fa-file-code"></i> Exportar datos JSON
                        </button>
                        <button class="holo-btn" onclick="printAnalytics()">
                            <i class="fas fa-print"></i> Imprimir análisis
                        </button>
                        <button class="holo-btn" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            
            // Mostrar modal con animación
            setTimeout(() => {
                modalOverlay.style.opacity = '1';
            }, 10);
            
            // Inicializar gráficos después de que el modal esté en el DOM
            setTimeout(() => {
                initAnalyticsCharts(analyticsData);
                init3DVisualization(analyticsData);
                
                // Configurar eventos para los botones de tipo de gráfico
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // Quitar clase active de todos los botones
                        document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                        
                        // Añadir clase active a este botón
                        this.classList.add('active');
                        
                        // Cambiar el tipo de gráfico
                        const chartType = this.dataset.chartType;
                        changeChartType(chartType);
                    });
                });
            }, 100);
        }

        // Inicializar gráficos para el análisis
        function initAnalyticsCharts(data) {
            const ctx = document.getElementById('main-chart').getContext('2d');
            
            // Configurar gráfico inicial (secciones)
            const sectionLabels = Object.keys(data.turnosPorSeccion);
            const sectionValues = sectionLabels.map(label => data.turnosPorSeccion[label]);
            
            // Colores basados en variables CSS
            const colors = [
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color1'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color2'),
                getComputedStyle(document.documentElement).getPropertyValue('--chart-color3')
            ];
            
            // Crear gráfico de pastel para secciones
            analyticsCharts.sectionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sectionLabels,
                    datasets: [{
                        data: sectionValues,
                        backgroundColor: colors,
                        borderColor: 'rgba(0, 0, 0, 0.2)',
                        borderWidth: 1,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--light'),
                                font: {
                                    family: "'Rajdhani', sans-serif",
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                family: "'Orbitron', sans-serif",
                                size: 14
                            },
                            bodyFont: {
                                family: "'Rajdhani', sans-serif",
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / data.totalTurnos) * 100);
                                    return `${label}: ${value} turnos (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Turnos por Sección',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
                            font: {
                                family: "'Orbitron', sans-serif",
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Preparar datos para los otros tipos de gráficos (se cambiarán cuando el usuario lo solicite)
            
            // Datos para gráfico por día
            const dayLabels = Array.from({length: 10}, (_, i) => `Día ${i + 25}`);
            const dayValues = data.turnosPorDia;
            
            // Datos para gráfico por puesto
            const postLabels = Object.keys(data.puestosMasDemandados).slice(0, 10);
            const postValues = postLabels.map(label => data.puestosMasDemandados[label]);
            
            // Guardar datos para uso posterior
            analyticsCharts.dayData = {
                labels: dayLabels,
                values: dayValues
            };
            
            analyticsCharts.postData = {
                labels: postLabels,
                values: postValues
            };
        }

        // Cambiar tipo de gráfico
        function changeChartType(chartType) {
            const ctx = document.getElementById('main-chart').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (analyticsCharts.sectionChart) {
                analyticsCharts.sectionChart.destroy();
            }
            
            // Colores de tema actual
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-color1');
            const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-color2');
            const tertiaryColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-color3');
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
            
            // Opciones comunes
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--light'),
                            font: {
                                family: "'Rajdhani', sans-serif",
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            family: "'Orbitron', sans-serif",
                            size: 14
                        },
                        bodyFont: {
                            family: "'Rajdhani', sans-serif",
                            size: 13
                        }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                }
            };
            
            switch (chartType) {
                case 'section':
                    // Configuración para gráfico de secciones (doughnut)
                    const sectionLabels = Object.keys(lastAnalyticsData.turnosPorSeccion);
                    const sectionValues = sectionLabels.map(label => lastAnalyticsData.turnosPorSeccion[label]);
                    
                    analyticsCharts.sectionChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: sectionLabels,
                            datasets: [{
                                data: sectionValues,
                                backgroundColor: [primaryColor, secondaryColor, tertiaryColor],
                                borderColor: 'rgba(0, 0, 0, 0.2)',
                                borderWidth: 1,
                                hoverOffset: 20
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                ...commonOptions.plugins,
                                title: {
                                    display: true,
                                    text: 'Distribución de Turnos por Sección',
                                    color: accentColor,
                                    font: {
                                        family: "'Orbitron', sans-serif",
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                tooltip: {
                                    ...commonOptions.plugins.tooltip,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const percentage = Math.round((value / lastAnalyticsData.totalTurnos) * 100);
                                            return `${label}: ${value} turnos (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    break;
                
                case 'day':
                    // Configuración para gráfico de días (bar)
                    analyticsCharts.sectionChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: analyticsCharts.dayData.labels,
                            datasets: [{
                                label: 'Turnos por día',
                                data: analyticsCharts.dayData.values,
                                backgroundColor: primaryColor,
                                borderColor: 'rgba(0, 0, 0, 0.2)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--light')
                                    },
                                    title: {
                                        display: true,
                                        text: 'Número de turnos',
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--light'),
                                        font: {
                                            family: "'Rajdhani', sans-serif"
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--light')
                                    }
                                }
                            },
                            plugins: {
                                ...commonOptions.plugins,
                                title: {
                                    display: true,
                                    text: 'Distribución de Turnos por Día',
                                    color: accentColor,
                                    font: {
                                        family: "'Orbitron', sans-serif",
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    });
                    break;
                
                case 'post':
                    // Configuración para gráfico de puestos (horizontal bar)
                    analyticsCharts.sectionChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: analyticsCharts.postData.labels,
                            datasets: [{
                                label: 'Demanda por puesto',
                                data: analyticsCharts.postData.values,
                                fill: true,
                                backgroundColor: 'rgba(148, 0, 211, 0.2)',
                                borderColor: primaryColor,
                                borderWidth: 2,
                                pointBackgroundColor: secondaryColor,
                                pointBorderColor: '#fff',
                                pointRadius: 5,
                                tension: 0.3
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--light')
                                    },
                                    title: {
                                        display: true,
                                        text: 'Número de turnos',
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--light'),
                                        font: {
                                            family: "'Rajdhani', sans-serif"
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--light')
                                    }
                                }
                            },
                            plugins: {
                                ...commonOptions.plugins,
                                title: {
                                    display: true,
                                    text: 'Demanda de Puestos de Vigilancia',
                                    color: accentColor,
                                    font: {
                                        family: "'Orbitron', sans-serif",
                                        size: 16,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    });
                    break;
            }
        }

        // Inicializar visualización 3D
        function init3DVisualization(data) {
            const canvas = document.getElementById('visualization-canvas');
            if (!canvas) return;
            
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            
            // Optimizar para móviles
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Configurar escena 3D
            const scene = new THREE.Scene();
            
            const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(10, 10, 20);
            camera.lookAt(0, 0, 0);
            
            const renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                alpha: true,
                antialias: !isMobile,
                powerPreference: "high-performance",
                precision: isMobile ? "mediump" : "highp"
            });
            
            renderer.setSize(width, height);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1.5 : 2.5));
            
            // Añadir iluminación optimizada para móviles
            if (isMobile) {
                // Iluminación simplificada para móviles
                const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
                scene.add(light);
            } else {
                // Iluminación completa para desktop
                const ambientLight = new THREE.AmbientLight(0x404040, 1);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(10, 10, 10);
                scene.add(directionalLight);
                
                const backLight = new THREE.DirectionalLight(0x2222ff, 0.2);
                backLight.position.set(-10, 5, -10);
                scene.add(backLight);
            }
            
            // Crear visualización 3D basada en los datos
            
            // 1. Crear grid para representar los días
            const gridHelper = new THREE.GridHelper(20, 10, 0x666666, 0x444444);
            gridHelper.position.y = -2;
            scene.add(gridHelper);
            
            // 2. Crear barras 3D para representar la cantidad de turnos por día
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            
            // Colores basados en el tema actual
            const color1 = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--chart-color1'));
            const color2 = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--chart-color2'));
            const color3 = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--chart-color3'));
            
            // Crear barras para cada día con geometría optimizada
            for (let i = 0; i < data.turnosPorDia.length; i++) {
                if (data.turnosPorDia[i] > 0) {
                    const height = data.turnosPorDia[i] * 0.5;
                    const material = new THREE.MeshPhongMaterial({ 
                        color: color1, 
                        transparent: true,
                        opacity: 0.8,
                        emissive: color1,
                        emissiveIntensity: 0.2,
                        flatShading: isMobile
                    });
                    
                    // Optimizar geometría para móviles
                    const barGeometry = isMobile ? 
                        new THREE.BoxGeometry(0.8, height, 0.8, 1, 1, 1) : 
                        new THREE.BoxGeometry(0.8, height, 0.8, 2, 1, 2);
                    
                    const bar = new THREE.Mesh(barGeometry, material);
                    bar.position.set(i * 2 - 9, height / 2, 0);
                    scene.add(bar);
                }
            }
            
            // 3. Crear esferas para representar los puestos más demandados
            const topPuestos = data.top5Puestos;
            for (let i = 0; i < Math.min(topPuestos.length, isMobile ? 3 : 5); i++) {
                const value = topPuestos[i][1] * 0.2;
                
                // Optimizar geometría para móviles
                const sphereSegments = isMobile ? 16 : 32;
                const sphereGeom = new THREE.SphereGeometry(value, sphereSegments, sphereSegments);
                
                const sphereMat = new THREE.MeshPhongMaterial({
                    color: color2,
                    transparent: true,
                    opacity: 0.7,
                    emissive: color2,
                    emissiveIntensity: 0.3,
                    flatShading: isMobile
                });
                
                const sphere = new THREE.Mesh(sphereGeom, sphereMat);
                sphere.position.set(-8 + i * 3, 3, -5);
                scene.add(sphere);
                
                // Añadir texto con el nombre del puesto
                const textDiv = document.createElement('div');
                textDiv.style.position = 'absolute';
                textDiv.style.color = 'white';
                textDiv.style.textShadow = '0 0 5px rgba(0,0,0,0.5)';
                textDiv.style.fontSize = '12px';
                textDiv.style.fontFamily = "'Orbitron', sans-serif";
                textDiv.textContent = topPuestos[i][0];
                textDiv.style.display = 'none'; // Se mostrará en animateVisualization
                
                document.body.appendChild(textDiv);
                
                // Guardar referencia para actualizar posición en animateVisualization
                sphere.userData = {
                    label: textDiv,
                    puesto: topPuestos[i][0]
                };
            }
            
            // Renderizado adaptativo para móviles
            let frameSkip = 0;
            const maxFrameSkip = isMobile ? 2 : 0; // Skip frames on mobile
            
            // Animar visualización 3D
            function animateVisualization() {
                requestAnimationFrame(animateVisualization);
                
                // Frame skipping para móviles
                if (frameSkip < maxFrameSkip) {
                    frameSkip++;
                    return;
                }
                frameSkip = 0;
                
                // Rotar la escena lentamente
                scene.rotation.y += 0.005 * (isMobile ? 0.7 : 1);
                
                // Actualizar posición de etiquetas
                scene.children.forEach(child => {
                    if (child.userData && child.userData.label) {
                        // Proyectar posición 3D a coordenadas 2D
                        const vector = new THREE.Vector3();
                        vector.setFromMatrixPosition(child.matrixWorld);
                        vector.project(camera);
                        
                        const x = (vector.x * 0.5 + 0.5) * canvas.clientWidth;
                        const y = (vector.y * -0.5 + 0.5) * canvas.clientHeight;
                        
                        // Solo mostrar si está en frente de la cámara
                        if (vector.z < 1) {
                            child.userData.label.style.display = 'block';
                            child.userData.label.style.left = `${x}px`;
                            child.userData.label.style.top = `${y}px`;
                        } else {
                            child.userData.label.style.display = 'none';
                        }
                    }
                });
                
                renderer.render(scene, camera);
            }
            
            // Iniciar animación
            animateVisualization();
            
            // Manejar redimensionamiento con throttling
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
                }, 250);
            });
            
            // Añadir funciones para interacción táctil
            canvas.userData = {
                rotate: function(x, y) {
                    scene.rotation.y += x;
                    scene.rotation.x += y;
                },
                resetView: function() {
                    scene.rotation.x = 0;
                    scene.rotation.y = 0;
                    scene.rotation.z = 0;
                    camera.position.set(10, 10, 20);
                    camera.lookAt(0, 0, 0);
                },
                zoom: function(scale) {
                    const currentPosition = camera.position.clone();
                    const direction = currentPosition.normalize();
                    const distance = camera.position.length();
                    const newDistance = Math.max(5, Math.min(30, distance / scale));
                    camera.position.copy(direction.multiplyScalar(newDistance));
                }
            };
            
            // Manejar limpieza cuando se cierra el modal
            const modalOverlay = canvas.closest('.modal-overlay');
            if (modalOverlay) {
                // Observer para detectar cuando el modal se elimine del DOM
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.removedNodes.forEach((node) => {
                            if (node === modalOverlay) {
                                // Limpiar escena y eliminar etiquetas
                                scene.children.forEach(child => {
                                    if (child.userData && child.userData.label) {
                                        document.body.removeChild(child.userData.label);
                                    }
                                });
                                
                                // Detener renderer
                                renderer.dispose();
                                
                                observer.disconnect();
                            }
                        });
                    });
                });
                
                observer.observe(modalOverlay.parentNode, { childList: true });
            }
        }

        // Exportar datos de análisis
        function exportAnalytics(format) {
            const data = lastAnalyticsData || prepareAnalyticsData();
            
            switch (format) {
                case 'pdf':
                    showToast('Generando PDF de análisis...');
                    setTimeout(() => {
                        showToast('PDF de análisis generado correctamente', 'success');
                    }, 1500);
                    break;
                case 'image':
                    // Capturar imagen del modal de análisis
                    showToast('Capturando imagen del análisis...');
                    setTimeout(() => {
                        showToast('Imagen del análisis guardada correctamente', 'success');
                    }, 1500);
                    break;
                case 'csv':
                    // Exportar datos de análisis en CSV
                    let csv = "Categoría,Valor\n";
                    csv += `Total Vigilantes,${data.totalVigilantes}\n`;
                    csv += `Total Turnos,${data.totalTurnos}\n`;
                    csv += `Promedio Turnos,${(data.totalTurnos / data.totalVigilantes).toFixed(2)}\n\n`;
                    
                    csv += "Sección,Vigilantes,Turnos,Promedio\n";
                    Object.keys(data.turnosPorSeccion).forEach(section => {
                        csv += `${section},${data.vigilantesPorSeccion[section]},${data.turnosPorSeccion[section]},${(data.turnosPorSeccion[section] / data.vigilantesPorSeccion[section]).toFixed(2)}\n`;
                    });
                    
                    csv += "\nDía,Turnos\n";
                    data.turnosPorDia.forEach((turnos, idx) => {
                        csv += `Día ${idx + 25},${turnos}\n`;
                    });
                    
                    csv += "\nPuesto,Cantidad\n";
                    data.top5Puestos.forEach(([puesto, cantidad]) => {
                        csv += `${puesto},${cantidad}\n`;
                    });
                    
                    // Crear y descargar archivo
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'analisis_vigilancia.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast('Análisis exportado en formato CSV', 'success');
                    break;
                case 'json':
                    // Exportar datos de análisis en JSON
                    const jsonData = {
                        metadata: {
                            title: "Análisis de Vigilancia",
                            fecha: new Date().toISOString(),
                            version: "1.0"
                        },
                        analytics: {
                            resumen: {
                                totalVigilantes: data.totalVigilantes,
                                totalTurnos: data.totalTurnos,
                                promedio: (data.totalTurnos / data.totalVigilantes).toFixed(2),
                                maxTurnos: data.maxTurnos,
                                vigilanteConMasTurnos: data.vigilanteConMasTurnos
                            },
                            seccion: Object.entries(data.turnosPorSeccion).map(([seccion, turnos]) => ({
                                nombre: seccion,
                                vigilantes: data.vigilantesPorSeccion[seccion],
                                turnos: turnos,
                                promedio: (turnos / data.vigilantesPorSeccion[seccion]).toFixed(2)
                            })),
                            dias: data.turnosPorDia.map((turnos, idx) => ({
                                dia: idx + 25,
                                turnos: turnos
                            })),
                            puestos: data.top5Puestos.map(([puesto, cantidad]) => ({
                                puesto: puesto,
                                cantidad: cantidad
                            }))
                        }
                    };
                    
                    // Crear y descargar archivo
                    const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                    const jsonUrl = URL.createObjectURL(jsonBlob);
                    const jsonLink = document.createElement('a');
                    jsonLink.setAttribute('href', jsonUrl);
                    jsonLink.setAttribute('download', 'analisis_vigilancia.json');
                    document.body.appendChild(jsonLink);
                    jsonLink.click();
                    document.body.removeChild(jsonLink);
                    
                    showToast('Análisis exportado en formato JSON', 'success');
                    break;
            }
        }

        // Imprimir análisis
        function printAnalytics() {
            const data = lastAnalyticsData || prepareAnalyticsData();
            const printWindow = window.open('', '_blank');
            
            // Estilos para impresión
            const printStyles = `
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    color: #333;
                }
                h1, h2, h3 {
                    color: #333;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #333;
                }
                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }
                .stat-card {
                    border: 1px solid #ddd;
                    padding: 15px;
                    border-radius: 5px;
                    text-align: center;
                }
                .stat-card h3 {
                    margin-top: 0;
                    font-size: 16px;
                    color: #555;
                }
                .stat-card .value {
                    font-size: 24px;
                    font-weight: bold;
                    margin: 10px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                th, td {
                    padding: 8px;
                    border: 1px solid #ddd;
                    text-align: left;
                }
                th {
                    background-color: #f5f5f5;
                }
                .section-title {
                    margin: 30px 0 15px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #ddd;
                }
                .footer {
                    margin-top: 50px;
                    text-align: center;
                    font-size: 12px;
                    color: #666;
                }
            `;
            
            // Contenido para la impresión
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Análisis de Vigilancia</title>
                    <style>${printStyles}</style>
                </head>
                <body>
                    <div class="header">
                        <h1>Análisis de Vigilancia - Conciertos/Feria</h1>
                        <p>Generado el: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                    </div>
                    
                    <h2 class="section-title">Resumen General</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Vigilantes</h3>
                            <div class="value">${data.totalVigilantes}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Turnos</h3>
                            <div class="value">${data.totalTurnos}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Promedio Turnos</h3>
                            <div class="value">${(data.totalTurnos / data.totalVigilantes).toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Máx. Turnos</h3>
                            <div class="value">${data.maxTurnos}</div>
                        </div>
                    </div>
                    
                    <h2 class="section-title">Hallazgos Principales</h2>
                    <ul>
                        <li><strong>Vigilante más activo:</strong> ${data.vigilanteConMasTurnos} con ${data.maxTurnos} turnos</li>
                        <li><strong>Puesto más demandado:</strong> ${data.top5Puestos[0][0]} con ${data.top5Puestos[0][1]} turnos</li>
                        <li><strong>Día con más actividad:</strong> Día ${data.turnosPorDia.indexOf(Math.max(...data.turnosPorDia)) + 25} con ${Math.max(...data.turnosPorDia)} turnos</li>
                    </ul>
                    
                    <h2 class="section-title">Turnos por Sección</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Sección</th>
                                <th>Vigilantes</th>
                                <th>Turnos</th>
                                <th>Promedio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(data.turnosPorSeccion).map(section => `
                                <tr>
                                    <td>${section}</td>
                                    <td>${data.vigilantesPorSeccion[section]}</td>
                                    <td>${data.turnosPorSeccion[section]}</td>
                                    <td>${(data.turnosPorSeccion[section] / data.vigilantesPorSeccion[section]).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h2 class="section-title">Turnos por Día</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Día</th>
                                <th>Turnos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.turnosPorDia.map((turnos, idx) => `
                                <tr>
                                    <td>Día ${idx + 25}</td>
                                    <td>${turnos}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h2 class="section-title">Puestos más Demandados</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Puesto</th>
                                <th>Cantidad de Turnos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.top5Puestos.map(([puesto, cantidad]) => `
                                <tr>
                                    <td>${puesto}</td>
                                    <td>${cantidad}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Generado por el Sistema de Vigilancia Analytics Extreme Edition</p>
                        <p>Fecha y hora: ${new Date().toLocaleString()}</p>
                        <p>Usuario: PFfrank13</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Imprimir cuando se cargue el contenido
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    showToast('Análisis enviado a impresión', 'success');
                }, 500);
            };
        }
    </script>
</body>
</html>